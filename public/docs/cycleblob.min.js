var cb=function(){function t(t,e){return Math.floor(Math.random()*(e-t+1))+t}function r(t){return Math.random()<t/100}function n(t){var e=Qe.getError();e!=Qe.NO_ERROR&&(n.codes||(n.codes={},n.codes[Qe.INVALID_ENUM]="INVALID_ENUM",n.codes[Qe.INVALID_VALUE]="INVALID_VALUE",n.codes[Qe.INVALID_OPERATION]="INVALID_OPERATION",n.codes[Qe.OUT_OF_MEMORY]="OUT_OF_MEMORY"),alert((t?t+" ":"")+"WebGL error: "+e+" "+n.codes[e]))}function o(t){return t*Math.PI/180}function a(t,e,i){function r(t,e,i){return 0>i&&(i+=1),i>1&&(i-=1),1/6>i?t+6*(e-t)*i:.5>i?e:2/3>i?t+(e-t)*(2/3-i)*6:t}var n,o,a;if(0==e)n=o=a=i;else{
var s=.5>i?i*(1+e):i+e-i*e,l=2*i-s;n=r(l,s,t+1/3),o=r(l,s,t),a=r(l,s,t-1/3)}return[n,o,a]}function s(){this.stack=[];for(var t=0;20>t;++t)this.stack.push(xe.create());this.stackTop=0,this.current=xe.create(),this.loadIdentity()}function l(t,e){var i=e;if(!i)return null;var r,n=i,o=n.text;if("x-shader/x-fragment"==n.type)r=t.createShader(t.FRAGMENT_SHADER);else{if("x-shader/x-vertex"!=n.type)return null;r=t.createShader(t.VERTEX_SHADER)}return t.shaderSource(r,o),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS)?r:(alert(t.getShaderInfoLog(r)+"\n"+n.id),null)}function u(){this.prog=null;
}function h(t){if(1!=arguments.length)throw new Error("GLBuffer() needs 1 arguments");this.buf=Qe.createBuffer(),this.target=t}function c(){return c.t||(c.t={},c.t[Qe.FLOAT]={byteSize:4,arrCtor:Float32Array},c.t[Qe.UNSIGNED_INT]={byteSize:4,arrCtor:Uint32Array},c.t[Qe.INT]={byteSize:4,arrCtor:Int32Array},c.t[Qe.UNSIGNED_SHORT]={byteSize:2,arrCtor:Uint16Array},c.t[Qe.SHORT]={byteSize:2,arrCtor:Int16Array},c.t[Qe.UNSIGNED_BYTE]={byteSize:1,arrCtor:Uint8Array},c.t[Qe.BYTE]={byteSize:1,arrCtor:Int8Array}),c.t}function f(){this.queue=[],this.pntRecord=[],this.standing=!0}function g(t,e,i){this.alive=!0,
this.model=e,this.id=t,this.ready=!1,this.modelColor=Se[t].model,this.trailColor=Se[t].trail,this.textColor=Se[t].text,this.name=Se[t].name,this.point=i,this.normal=ve.create([0,0,1]),this.rightHand=ve.create([1,0,0]),this.upDir=ve.create([0,1,0]),this.forward=this.upDir,this.last={point:-1,normal:null,upDir:null,forward:null},this.last.point=m(this.point,ve.nnegate(this.forward)),this.eDir=_e.Up,this.selDir=_e.Up,this.wall=new f,this.ai=null,this.sfx={explode:null,wall_decent:null},this.lastMadeMoves=0,this.dNow2Last=0,this.dNow2Point=0,this.curStepFrac=1,this.lastMvDist=1,this.turnCallback=null,
this.stepCount=0,this.selDir.move.call(this)}function m(t,e){var r=ri.model.vtx[t],n=ri.model.nei[t].d,o=-100,a=-100;for(i in n){var s=ri.model.vtx[i],l=ve.normalize(ve.nsubtract(s,r)),u=ve.dot(e,l);u>o&&(o=u,a=i)}return parseInt(a)}function v(t,e,i){for(var r=ri.model.nei[t],n=e[r.nc],o=i,a=0;n>a;++a)o=r.t[o];return o}function w(t,e){for(var i=ri.model.nei[t],r={},n=e,o=Me.rightHand[i.nc],a=0;o>a;++a)n=i.t[n];r.toRight=n,o=Me.forward[i.nc]-Me.rightHand[i.nc];for(var a=0;o>a;++a)n=i.t[n];r.toFwd=n,o=Me.leftHand[i.nc]-Me.forward[i.nc];for(var a=0;o>a;++a)n=i.t[n];return r.toLeft=n,r}function x(t){
De.mouseDown=!0,De.lastMouseX=t.clientX,De.lastMouseY=t.clientY}function y(t){De.mouseDown=!1}function b(t){if(De.mouseDown){var e=t.clientX,i=t.clientY;if(We.debug){var r=e-De.lastMouseX,n=i-De.lastMouseY,a=xe.nidentity();xe.rotateY(a,o(r/2)),xe.rotateX(a,o(n/2)),xe.multiply(a,De.rotationMatrix,De.rotationMatrix),De.lastMouseX=e,De.lastMouseY=i}}}function _(t){var e=!0;return void 0!==Ae[t.keyCode]?(De.currentlyPressedDirs.push({dir:Ae[t.keyCode],skippedCount:0}),e=!1):t.keyCode===Ee._DOM_VK_OPEN_SQUARE?(De.currentlyPressedDirs.push({reldir:_e.Left,skippedCount:0}),e=!1):t.keyCode===Ee._DOM_VK_CLOSE_SQUARE&&(De.currentlyPressedDirs.push({
reldir:_e.Right,skippedCount:0}),e=!1),t.keyCode===Ee.DOM_VK_P||t.keyCode===Ee.DOM_VK_PAUSE?(Ke.setPaused(!Ke.isPaused()),e=!1):t.keyCode===Ee.DOM_VK_M?(Ke.enableSound(!Ke.soundEnabled),e=!1):t.keyCode===Ee.DOM_VK_ESCAPE?(Ke.setPaused(!0),hi.verbosePauseScreen(),e=!1):!We.debug&&Ke.isPaused()&&(Ke.setPaused(!1),e=!1),t.keyCode===Ee.DOM_VK_SPACE&&(e=!1),We.debug&&(t.keyCode===Ee.DOM_VK_E?G(ni,1):t.keyCode===Ee.DOM_VK_U?(++Ke.userLivesCount,ri.staticDraw.lives.startOneUp()):t.keyCode===Ee.DOM_VK_B&&X()),e}function S(t){}function M(t){for(var e in De.currentlyPressedDirs){var i=De.currentlyPressedDirs[e];
void 0!==i&&(i.dir?moveDir=ai.translateDir(i.dir,t):moveDir=ai.translateRelativeDir(_e.getRelativeDir(t.eDir,i.reldir,t)),Xe("SAMP-DIR "+moveDir.name),null!==moveDir&&moveDir!==t.eDir.opposite?(t.selDir=moveDir,Ke.isPaused()&&We.debug&&(Xe("DO"),ne(ni),ni.curStepFrac=1),De.currentlyPressedDirs[e]=void 0):(++i.skippedCount,i.skippedCount>4&&(De.currentlyPressedDirs[e]=void 0)))}}function D(t){return t.preventDefault(),Te=t.touches[0].clientX,Re=t.touches[0].clientY,!1}function E(t){if(t.preventDefault(),!Te||!Re)return!1;var e=t.touches[0].clientX,i=t.touches[0].clientY,r=Te-e,n=Re-i,o=Math.abs(r),a=Math.abs(n);
Xe("TOUCH "+r+" "+n);var s=null;return o>a?o>10&&(s=r>0?_e.Left:_e.Right):a>10&&(s=n>0?_e.Up:_e.Down),null!==s&&(De.currentlyPressedDirs.push({dir:s,skippedCount:0}),Te=null,Te=null,Ke.setPaused(!1)),!1}function A(t){return t.preventDefault(),Te=null,Te=null,!1}function T(t,e){t.onmousedown=x,e.onmousedown=x,document.onmouseup=y,document.onmousemove=b,document.onkeydown=_,document.onkeyup=S,document.body.addEventListener("touchstart",D,!1),document.body.addEventListener("touchmove",E,!1),document.body.addEventListener("touchend",A,!1),document.body.addEventListener("touchcancel",A,!1),De.handlersSet=De.HANDLERS_3D;
}function R(t,e){var i=["triangles","lines"];for(var r in i){var n=i[r];t[n]&&(e[n]=h.Data(Qe.ELEMENT_ARRAY_BUFFER,new Uint16Array(t[n]),Qe.STATIC_DRAW,1))}if(t.quads){var o=new Uint16Array(t.quads.length/4*6);ti=0;for(var r=0;r<t.quads.length;r+=4)o[ti++]=t.quads[r],o[ti++]=t.quads[r+1],o[ti++]=t.quads[r+2],o[ti++]=t.quads[r],o[ti++]=t.quads[r+2],o[ti++]=t.quads[r+3];e.triangles=h.Data(Qe.ELEMENT_ARRAY_BUFFER,o,Qe.STATIC_DRAW,1)}}function I(t,e){if(e.vertexBuffer=h.Data(Qe.ARRAY_BUFFER,new Float32Array(t.vertexPositions),Qe.STATIC_DRAW,3),t.vertexNormals&&(e.vNormalBuffer=h.Data(Qe.ARRAY_BUFFER,new Float32Array(t.vertexNormals),Qe.STATIC_DRAW,3)),
t.vertexTextureCoords&&(e.vTexCoord=h.Data(Qe.ARRAY_BUFFER,new Float32Array(t.vertexTextureCoords),Qe.STATIC_DRAW,2)),t.groups){e.groups=[];for(var i in t.groups){var r=t.groups[i],n={};R(r,n),e.groups.push(n)}}else R(t,e)}function P(t,e){e.groups=[];for(var i in t.groups){for(var r=t.groups[i],n={},o=[],a=[],s=0;s<r.triangles.length;){for(var l=[],u=0;3>u;++u){var d=r.triangles[s],c=[t.vertexPositions[3*d],t.vertexPositions[3*d+1],t.vertexPositions[3*d+2]];o.push.apply(o,c),l[u]=c,++s}for(var p=ve.ncross(ve.nsubtract(l[0],l[1]),ve.nsubtract(l[0],l[2])),u=0;3>u;++u)a.push(p[0],p[1],p[2])}n.vertexBuffer=h.Data(Qe.ARRAY_BUFFER,new Float32Array(o),Qe.STATIC_DRAW,3),
n.vNormalBuffer=h.Data(Qe.ARRAY_BUFFER,new Float32Array(a),Qe.STATIC_DRAW,3),n.trianglesInline=!0,n.diffuseColor=r.diffuseColor,e.groups.push(n)}}function L(t,e,i){t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2]}function k(t,e,i,r){for(var n=new Float32Array(3*t.totalNeiCount),o=new Float32Array(3*t.totalNeiCount),a=[],s=[],l=0,u=0,d=0;d<t.nei.length;++d)t.nei[d].tc={};var d=0,c=function(){for(var e=0;100>e;++e){var i=t.vtx[d],r=t.normals[d],h=Object.keys(t.nei[d].t),f=t.nei[d].nc;for(var g in t.nei[d].d)t.nei[d].tc[g]=[];for(var m=s[d]=l,v=t.nei[d].t[h[0]],w=0;f>w;++w){var x=t.nei[d].t[v],y=ve.nsubtract(t.vtx[v],i),b=ve.nsubtract(t.vtx[x],i),_=y;
ve.normalize(ve.add(_,b)),ve.scale(_,1.41421*t.scale.GRID_LINE_WIDTH),ve.add(_,i),t.nei[d].tc[v].unshift(l),t.nei[d].tc[x].push(l),L(n,u,_),L(o,u,r),++l,u+=3,v=x}for(var S=1;S<t.nei[d].nc-1;++S)a.push(m,m+S,m+S+1);if(++d,d>=t.vtx.length)break}var M=d<t.vtx.length?c:p;return M},p=function(){l>65536&&alert("model too big "+vtxBuf.length+" vertices");for(var e=new Array(t.vtx.length),i=0;i<e.length;++i)e[i]={};for(var i=0;i<t.vtx.length;++i)for(var r in t.nei[i].d){r=parseInt(r);var u=r>i?[i,r]:[r,i];if(!e[u[0]][u[1]]){e[u[0]][u[1]]=!0;var d=t.nei[i].tc[r],c=t.nei[r].tc[i];a.push(d[0],c[1],c[0]),a.push(d[0],c[0],d[1]);
}}delete e,delete s,"undefined"!=typeof Qe?(t.vertexBuffer=h.Data(Qe.ARRAY_BUFFER,n,Qe.STATIC_DRAW,3),t.vNormalBuffer=h.Data(Qe.ARRAY_BUFFER,o,Qe.STATIC_DRAW,3),t.triangles=h.Data(Qe.ELEMENT_ARRAY_BUFFER,new Uint16Array(a),Qe.STATIC_DRAW,1),delete n,delete o,delete a):(t.vertexBuffer=n,t.vNormalBuffer=o,t.triangles=new Uint16Array(a));for(var i=0;i<t.nei.length;++i)delete t.nei[i].tc;return null},f=c,g=function(){f=f(),null===f?(r&&r(1),i()):r&&(e=r(d/(t.vtx.length+200)))},m=function(){if(g(),null!==f&&e)setTimeout(m,100);else for(;null!==f&&!e;)g()};m()}function C(t,e,i){return ve.distance(t.vtx[e],t.vtx[i]);
}function O(t,e){e.vtx=[],e.bbox={min:ve.create([99,99,99]),max:ve.create([-99,-99,-99])};for(var i=0;i<t.vertexPositions.length;i+=3)p=ve.create([t.vertexPositions[i],t.vertexPositions[i+1],t.vertexPositions[i+2]]),e.vtx.push(p),ve.minwith(e.bbox.min,p),ve.maxwith(e.bbox.max,p);if(e.bbox.size=ve.distance(e.bbox.min,e.bbox.max),Xe(e.vtx.length+" vertices in world bbox="+e.bbox.size),e.normals=[],t.vertexNormals)for(var i=0;i<t.vertexNormals.length;i+=3)e.normals.push(ve.create([t.vertexNormals[i],t.vertexNormals[i+1],t.vertexNormals[i+2]]));e.nei=[];for(var r=new Array(e.vtx.length),i=0;i<r.length;++i)r[i]={
d:{},t:{},nc:0};if(!t.quads)throw new Error("not supported");for(var n,o=0,a=0,i=0;i<t.quads.length;i+=4){var s=t.quads[i],l=t.quads[i+1],u=t.quads[i+2];n=t.quads[i+3],ds=C(e,s,l),r[s].d[l]=ds,r[l].d[s]=ds,o+=ds,ds=C(e,l,u),r[l].d[u]=ds,r[u].d[l]=ds,o+=ds,ds=C(e,u,n),r[u].d[n]=ds,r[n].d[u]=ds,o+=ds,ds=C(e,n,s),r[n].d[s]=ds,r[s].d[n]=ds,o+=ds,a+=4,r[s].t[l]=n,r[l].t[u]=s,r[u].t[n]=l,r[n].t[s]=u}for(var h=0,i=0;i<r.length;++i){var d=Object.keys(r[i].t);r[i].nc=d.length,h+=d.length}e.totalNeiCount=h,e.distAvg=o/a,e.scale=F(e.distAvg),Xe(e.distAvg),e.nei=r}function F(t){var e={};return e.GRID_LINE_WIDTH=.19*t,
e.WALL_WIDTH=.28*t,e.WALL_HEIGHT=1.92*t,e.BIKE_SCALE=.96*t,e.BASE_SPEED=.01522*t,e.GLOBAL_SCALE=t/.052,e.BONUS_LIFE=.475*t,e}function B(t){for(var e=[],i=[],r=[],n=0;Ie>n;++n){var o=2*Math.PI/Ie*n,a=Math.cos(o),s=Math.sin(o);e.push(a,s,0,a*(1+Pe),s*(1+Pe),0),i.push(0,0,1,0,0,1),r.push(2*n,2*n+1)}r.push(0,1),t.ring={},t.ring.vertexBuffer=h.Data(Qe.ARRAY_BUFFER,new Float32Array(e),Qe.STATIC_DRAW,3),t.ring.vNormalBuffer=h.Data(Qe.ARRAY_BUFFER,new Float32Array(i),Qe.STATIC_DRAW,3),t.ring.triangleStrip=h.Data(Qe.ELEMENT_ARRAY_BUFFER,new Uint16Array(r),Qe.STATIC_DRAW,1),e=[],i=[];for(var l=[],u=2*Math.PI/Le,n=0;Le>n;++n){
var o=u*n;o+=(Math.random()-.5)*u;var d=.4*(Math.random()-.5)+1,a=Math.cos(o),s=Math.sin(o),c=s*ke,p=-a*ke;e.push(a*d,s*d,0,c,p,0,-c,-p,0),i.push(0,0,1,0,0,1,0,0,1),l.push(3*n,3*n+1,3*n+2)}t.spikes={},t.spikes.vertexBuffer=h.Data(Qe.ARRAY_BUFFER,new Float32Array(e),Qe.STATIC_DRAW,3),t.spikes.vNormalBuffer=h.Data(Qe.ARRAY_BUFFER,new Float32Array(i),Qe.STATIC_DRAW,3),t.spikes.triangleStrip=h.Data(Qe.ELEMENT_ARRAY_BUFFER,new Uint16Array(l),Qe.STATIC_DRAW,1)}function N(t,e){this.player=t;var i=Ce[e];this.stepsAhead=i.stepsAhead,this.look=new H,this.occFwd=!0,this.occLeft=!0,this.occRight=!0}function U(t){
var e=ri.map.getPiece(t);return void 0!==e&&e>=0}function H(t,e){this.init(t,e)}function V(t,e,i){return 0===e?i:t.goForward()?V(t,e-1,i+1):i}function W(t,e){return t>=100&&200>t&&t-100==e}function K(t){this.player=t,this.ringsScale=[-1,-.5,.01],this.elapsed=0,this.showSpikes=!0,this.spikesScale=.1}function G(t,e){100>e&&e==ni.id&&(t=ni),t.sfx.explode=new K(t)}function Y(t){this.player=t,this.brightness=0,this.height=1,this.elapsed=0}function q(t){t.sfx.wall_decent=new Y(t)}function z(t){window.setTimeout(function(){q(t)},K.TOTAL_TIME+Y.START_DELAY)}function X(){if(!(Object.keys(ri.bonuses).length>=5||ri.bonuses.length>99)){
var t=new Q(ri.bonuses.length);null!==t.point&&ri.bonuses.push(t)}}function Q(t){var e=Ct();if(this.point=e[0],null!==this.point){this.index=t,this.occupy=e;for(var i in this.occupy)ri.map.set(this.occupy[i],1e3+t,0);this.normal=ri.model.normals[this.point],this.forward=ve.normalize(ve.nsubtract(ri.model.vtx[this.point],ri.model.vtx[e[1]])),this.rightHand=ve.ncross(this.forward,this.normal),this.forward=ve.ncross(this.normal,this.rightHand),this.anglex=0,this.angley=0,this.elapsed=0,this.inflate=0,this.active=!0,this.removeElapsed=-1,this.alpha=null,hi.addMessage("Life bonus appeared")}}function j(t){
this.eye=ve.create([0,0,1]),this.upDir=ve.create([0,1,0]),this.eyeDist=t,this.toPoint=ve.create([0,0,0]),this.twoSided=!1,this.addNearClip=0,this.lightPoint=[-10,4,20]}function Z(){this.eye=ve.create([0,0,0]),this.upDir=ve.create([0,1,0]),this.toPoint=ve.create([0,0,1]),this.centerDist=1.5,this.addNearClip=Math.max(0,this.centerDist-.8),this.twoSided=!0,this.bikeFlip=!0,this.lightPoint=[0,-4,20]}function J(){this.eye=ve.create([0,0,0]),this.upDir=ve.create([0,1,0]),this.toPoint=ve.create([0,0,0]),this.t=ve.create(),this.twoSided=!1,this.addNearClip=0,this.lightPoint=[-10,4,20]}function $(t,e,i,r){
this.x=Oe(t),this.y=Oe(e),this.height=Oe(r),this.width=Oe(i)}function tt(t,e,i){var r=hi.getCanvasCoord(t);e.base.callback.call(e,e.box?{x:r.x-e.box.x,y:r.y-e.box.y,name:i}:void 0)}function et(t){if(hi.curPage.mouseCaptureWidget)return void tt(t,hi.curPage.mouseCaptureWidget,dt.EVENT_MOVE);var e=hi.getWidget(t);null!==e&&e.base.index!==hi.curPage.sel&&(hi.curPage.sel=e.base.index,hi.drawWidgets())}function it(t){var e=hi.getWidget(t);null!==e?tt(t,e,dt.EVENT_PRESS):null!==hi.curPage.mouseHandler&&hi.curPage.mouseHandler()}function rt(t){hi.curPage.mouseCaptureWidget&&(tt(t,hi.curPage.mouseCaptureWidget,dt.EVENT_RELEASE),
hi.curPage.mouseCaptureWidget=null)}function nt(t){var e=hi.getWidget(t);if(null!==e&&void 0!==e.onWheelEvent)return e.onWheelEvent(t),!1;for(var i=hi.curPage.wheelHandlers,r=0;r<i.length;++r)if(i[r].box.inside(t))return i[r].handler(t),!1;return!0}function ot(t){var e;if(hi.curPage.widgets.length>0){if(e=!1,t.keyCode===Ee.DOM_VK_DOWN||t.keyCode===Ee.DOM_VK_RIGHT)hi.curPage.sel=(hi.curPage.sel+1)%hi.curPage.widgets.length;else if(t.keyCode===Ee.DOM_VK_UP||t.keyCode===Ee.DOM_VK_LEFT)hi.curPage.sel=(hi.curPage.sel-1+hi.curPage.widgets.length)%hi.curPage.widgets.length;else if(t.keyCode===Ee.DOM_VK_RETURN||t.keyCode===Ee.DOM_VK_ENTER||t.keyCode===Ee.DOM_VK_SPACE){
var i=hi.curPage.widgets[hi.curPage.sel];i.base.callback.call(i)}else e=!0;if(e===!1)return hi.drawWidgets(),e}return null!==hi.curPage.keyHandler?hi.curPage.keyHandler(t.keyCode):!0}function at(t){}function st(t){t.preventDefault(),Te=t.touches[0].clientX-drawDiv.offsetLeft,Re=t.touches[0].clientY-drawDiv.offsetTop,e={layerX:Te,layerY:Re},it(e)}function lt(t){t.preventDefault()}function ut(t){t.preventDefault()}function ht(){this.curPage=null,this.msgQueue=[],this.curMenuDraw=null,this.curMenuRemake=null,this.texth=42,this.has3dContent=!1,this.render3d=[],this.mainMenu=null,this.menuAnim=null,
window.setInterval(function(){hi.checkMessageQueue()},200)}function dt(t,e){this.callback=t,this.index=e}function ct(t,e,i,r){this.base=i,this.text=t,this.tx=e.x,this.ty=e.y+e.height,this.box=e.expanded(Oe(hi.em/4)).down(Oe(hi.em/7)),this.group=r,this.group&&this.group.setBox(e.expanded(Oe(hi.em/8)).down(Oe(hi.em/7)))}function pt(t){var e=li.createLinearGradient(t.x,t.y,t.x+t.width,t.y+t.height);return e.addColorStop(0,"#773cff"),e.addColorStop(1,"#f4204a"),e}function ft(t){return"#7c007e"}function gt(t,e,i,r,n,o){this.base=o,this.imgOn=t,this.imgOff=e,this.text=i,this.boxImg=n,this.box=n.expanded(Oe(hi.em/4)),
this.isOn=r,this.toggleCallback=this.base.callback,this.base.callback=function(){this.isOn=!this.isOn,this.toggleCallback(this.isOn),this.draw(!0)}}function mt(t,e,i,r,n){this.base=r,this.img=t,this.text=e,this.boxImg=i,this.box=i.expanded(Oe(hi.em/4)),this.group=n,this.group&&this.group.setBox(i.expanded(Oe(hi.em/8)))}function vt(t,e,i,r,n,o){this.base=o,o.box=n,this.vmin=t,this.vmax=e,this.step=i,this.value=r,this.box=n,this.valueChanged=o.callback,this.base.callback=this.onevent,this.clearBox=n.expanded(2).widen(.5*hi.en),this.valueChanged(this.value)}function wt(t,e,i,r,n){this.base=n,n.box=r,
this.box=r,this.total=t,this.part=e,this.valueChanged=n.callback,this.base.callback=this.onevent,this.value=i,this.clearBox=r.expanded(2),this.h=0,this.pressY=null,this.pressH=null}function xt(t){this.sel=t}function yt(t,e){this.id=e,this.com=t}function bt(t,e){this.box=e,this.allwidgets=t,this.d=[],this.length=0,this.translateY=0,e&&(this.drawScroll={x:e.x+e.width+12,y:e.y-7,height:e.height+14})}function _t(t){this.anglex=0,this.angley=0,this.box=t}function St(t){this.box=t}function Mt(t){this.box=t,this.move=0,this.colors=[];for(var e=0;e<Se.length;++e)e!==We.userIndex&&this.colors.push(Se[e].model);
}function Dt(t){this.anglex=0,this.angley=0,this.color=ve.x(t.modelColor,1.5),this.count=Ke.userLivesCount,this.activeDeath=void 0,this.activeOneUp=void 0,this.lightFactor=1,this.pendingDeath=!1;var e=Qe.viewportWidth/Qe.viewportHeight;this.prMatrix=xe.ortho(0,e,1,0,.1,100)}function Et(e){var i,r;if("number"==typeof e?(i=Ve[e],r=e):(i=e,r=-1),Xe("** START"+e),void 0===i||void 0===qe[i.worldModel]||void 0===qe[i.worldModel].model)throw new Error("not implemented");ri={ready:!1},ri.model=qe[i.worldModel].model,Nt(),i.speed||(i.speed=1),Ke.currentLevelNum=r,Ke.currentLevel=i,oi=[];for(var n=0;n<i.numPlayers;++n){
var o=t(0,ri.model.vtx.length-1),a=new g(n,qe.bike,o);n!==We.userIndex&&(a.ai=new N(a,i.ai)),oi.push(a)}We.userIndex>=0?(ni=oi[We.userIndex],ni.turnCallback=Bt):ni=oi[0];for(var s in oi)oi[s].init();ri.map=new ue,i.view?i.view===He.Inside?ai=new Z:i.view===He.FirstPerson&&(ai=new J):ai=new j(worldModels[i.worldModel].eyeDist),ai.moveUpdate(ni),Ke.isDemo?Ke.setAbsPaused(!1):(Ke.setAbsPaused(!0),Ke._startPause=!0),Ge={handler:null,called:!1},hi.clearMessages(),0===r&&hi.addMessage("Use the arrow keys to start the game",ht.MSGID_START_ARROWS),ri.staticDraw={lives:new Dt(ni)},ri.bonuses=[],ri.background=new jt(qe.background,.28*ri.model.bbox.size),
ri.ready=!0,he(!0),hi.drawGameState(),Tt()}function At(){this.currentLevelNum=0,this.currentLevel=null,this.userLivesCount=3,this.isDemo=!1,this._paused=0,this._startPause=!1;var t=null;this.soundEnabled=null!==t?"true"===t:!0}function Tt(){T($e,si)}function Rt(t){Ke.currentLevelNum=0,Ke.userLivesCount=3,Et(t?t:0)}function It(){Ge.called=!0,ri.staticDraw.lives.startDeath(),Xe("lives remaining: "+Ke.userLivesCount),Ke.userLivesCount>0?hi.lifeEndScreen(Ke.currentLevel,Ke.currentLevelNum):hi.gameOverScreen(Ke.currentLevel,Ke.currentLevelNum)}function Pt(){Ge.called=!0,We.disableEndLevel||(Ke.setAbsPaused(!0),
hi.levelComplete(Ke.currentLevelNum,Ke.currentLevel))}function Lt(t,e){if(G(t,e),Ut(t),kt(t,e),!We.disableDeath)if(t.curStepFrac=1,t.wall.deathEnd(t),t.alive=!1,z(t),t===ni)--Ke.userLivesCount,Ge.called===!1&&(Ge={handler:It,called:!1});else{for(var i=0,r=0;r<oi.length;++r)oi[r].alive&&++i;1===i&&Ge.called===!1&&(Ge={handler:Pt,called:!1})}}function kt(t,e){var i;if(e>=100){var r=e-100;i=r===t.id?t.prettyName()+" collided with its own wall":t.prettyName()+" collided with wall of "+oi[r].prettyName()}else{var r=e;i=t.prettyName()+" collided with "+oi[r].prettyName()}hi.addMessage(i),Xe(i+" on "+t.point);
}function Ct(){var e,i,r,n=0;do{if(n++>10)return[null];if(e=t(0,ri.model.vtx.length-1),void 0===ri.map.get(e)){r=ri.model.nei[e].t,i=!0;for(var o in r)i|=void 0===ri.map.get(r[o])}}while(!i);var a=[e];for(var o in r)a.push(r[o]);return a}function Ot(t,e){this.numChannels=e,this.curChannel=0,this.players=[],this.players[0]=t;for(var i=0;i<this.numChannels;++i){var r=new Audio;r.onerror=function(t){Xe("  SND ERROR"+t.currentTarget.error.code)},r.src=t.currentSrc,r.load(),this.players[i]=r}}function Ft(){Ye={},Ye.turn=new Ot(turnSound1,5),Ye.start=new Ot(powerupSound,1),Ye.crash=new Ot(crashSound,2),
Ye.bonus=new Ot(coinUp,1)}function Bt(t){Ke.soundEnabled&&Ye.turn.play(1)}function Nt(){Ke.soundEnabled&&Ye.start.play(.4)}function Ut(t){if(Ke.soundEnabled){var e=t===ni?1:.2;Ye.crash.play(e)}}function Ht(t){if(Ke.soundEnabled){var e=t===ni?1:.2;Ye.bonus.play(e)}}function Vt(t,e){return null===e?(delete ze.items[t],void(ze.ondone&&0===Object.keys(ze.items).length&&(ze.onprogress=null,ze.ondone(),ze.ondone=null))):void(ze.items[t]=e)}function Wt(t){if(0===Object.keys(ze.items).length)return void t();hi.loadingScreen(0),ze.ondone=t;ze.onprogress=function(t){return hi.loadingScreen(t),!1}}function Kt(t,e){
Vt(t,"processing");var i=qe[t],r={},n=(new Date).getTime();Xe("start "+t),O(i.input,r),k(r,e,function(){i.model=r,Xe("done "+t+" "+((new Date).getTime()-n)),Vt(t,null)},function(t){return ze.onprogress?ze.onprogress(t):!0})}function Gt(t){qe[t]&&qe[t].model&&(Xe("deleting "+t),delete qe[t].model)}function Yt(t,e,i){var r={input:e,name:t};qe[t]=r,i.gridProc?Kt(t,i.async):Vt(t,null)}function qt(t,e,i){if(Ve[t]){var r=Ve[t].worldModel;return void 0===qe[r]||void 0===qe[r].input?void Qt(worldModels[r].file,"none",r,Yt,{gridProc:e,async:i}):void(void 0===qe[r].model&&e&&Kt(r,i))}}function zt(t,e,i){
var r=Ve[t];if(void 0===r)throw new Error("level not found");if(void 0!==qe[r.worldModel]&&void 0!==qe[r.worldModel].model)return void(i&&i());for(var n=!0,o=0;t>o;++o)Gt(Ve[o].worldModel);for(var o=t+e;o<Ve.length;++o)Gt(Ve[o].worldModel);for(var o=0;e>o;++o)qt(t+o,!0,n);i&&Wt(i)}function Xt(t,e){qe[t]=e,Vt(t,null),qe.life&&qe.bike&&(qe._ready=!0,n("rcsinit"))}function Qt(t,e,i,r,n){Vt(i,"loading");var o=function(t){if("indexed"===e){var o={};I(t,o),r(i,o,n)}else if("inlined"===e){var o={};P(t,o),r(i,o,n)}else{if("none"!==e)throw"unknown load method";r(i,t,n)}},a=new XMLHttpRequest;a.onreadystatechange=function(){
if(4==this.readyState){if(200!=this.status)throw"failed loading file "+t;o(JSON.parse(a.responseText))}},a.open("GET",t,!0),a.send()}function jt(t,e){this.model=t,this.scale=e,this.time=0}function Zt(t){var e=[-5.28,-1.72,-2.78,0,0,-6.21,0,-5.55,-2.78,5.28,-1.72,-2.78,3.26,-4.49,2.78,0,0,6.21,-3.26,-4.49,2.78,5.28,1.72,2.78,-5.28,1.72,2.78,-3.26,4.49,-2.78,3.26,4.49,-2.78,0,5.55,2.78],i=[0,1,2,2,3,4,4,5,6,7,5,4,2,1,3,7,4,3,0,8,9,2,6,0,3,1,10,5,8,6,9,1,0,1,9,10,10,9,11,8,11,9,11,7,10,4,6,2,8,0,6,7,11,5,10,7,3,5,11,8];t.vertexBuffer=h.Data(Qe.ARRAY_BUFFER,new Float32Array(e),Qe.STATIC_DRAW,3),t.triangles=h.Data(Qe.ELEMENT_ARRAY_BUFFER,new Uint16Array(i),Qe.STATIC_DRAW,1);
}function Jt(t,e,i){t.triangles&&(t.triangles.bind(),Qe.drawElements(Qe.TRIANGLES,t.triangles.numItems,t.triangles.type,0)),t.triangleStrip&&(t.triangleStrip.bind(),Qe.drawElements(Qe.TRIANGLE_STRIP,t.triangleStrip.numItems,t.triangleStrip.type,0)),t.lines&&(Qe.lineWidth(3),t.lines.bind(),Qe.drawElements(Qe.LINES,t.lines.numItems,t.lines.type,0)),t.trianglesInline&&(t.diffuseColor?i.setColor(t.diffuseColor[0],t.diffuseColor[1],t.diffuseColor[2]):e&&i.setColorv(e),t.vertexBuffer.bind(),Qe.vertexAttribPointer(i.vertexPositionAttribute,t.vertexBuffer.itemSize,Qe.FLOAT,!1,0,0),t.vNormalBuffer.bind(),
Qe.vertexAttribPointer(i.vertexNormalAttribute,t.vNormalBuffer.itemSize,Qe.FLOAT,!1,0,0),Qe.drawArrays(Qe.TRIANGLES,0,t.vertexBuffer.numItems))}function $t(t,e){var i=u.current;if(t.vertexBuffer&&(t.vertexBuffer.bind(),Qe.vertexAttribPointer(i.vertexPositionAttribute,t.vertexBuffer.itemSize,Qe.FLOAT,!1,0,0)),t.vNormalBuffer&&(t.vNormalBuffer.bind(),Qe.vertexAttribPointer(i.vertexNormalAttribute,t.vNormalBuffer.itemSize,Qe.FLOAT,!1,0,0)),i.setMatrixUniforms(),Jt(t,void 0,i),t.groups)for(var r in t.groups)Jt(t.groups[r],e,i)}function te(t,e,i){var r=we.create([t[0],t[1],t[2],e[0],e[1],e[2],i[0],i[1],i[2]]);
return we.toMat4(r)}function ee(t){var e=t.curStepFrac,i=ve.linearMix(ri.model.vtx[t.point],ri.model.vtx[t.last.point],e);ye.translate(i);var r=t.getBikeOrient(),n=te(t.rightHand,r.normal,r.forward);ye.multMatrix(n)}function ie(){var t=!0;if(ei.setUseLight(t),t){var e={rgb:[.2,.2,.2]};Qe.uniform3f(ei.ambientColorUniform,e.rgb[0],e.rgb[1],e.rgb[2]);var i=ai.getLight();Qe.uniform3f(ei.pointLightingLocationUniform,i[0],i[1],i[2]);var r={rgb:[.8,.8,.8]};Qe.uniform3f(ei.pointLightingDiffuseColorUniform,r.rgb[0],r.rgb[1],r.rgb[2])}}function re(){Qe.viewport(0,0,Qe.viewportWidth,Qe.viewportHeight),Qe.clear(Qe.COLOR_BUFFER_BIT|Qe.DEPTH_BUFFER_BIT),
++Je,be.perspective(45,$e.width/$e.height,.1+ai.addNearClip,100),ie(),ye.loadIdentity(),u.use(ei);for(var t in ri.staticDraw)ri.staticDraw[t].render();var e=ai.getCamera();ye.multMatrix(xe.lookAt(e.eye,e.toPoint,e.upDir)),We.debug&&ye.multMatrix(De.rotationMatrix),ei.setColor(1,1,1),ei.setTwoSided(e.twoSided),$t(ri.model);for(var i=0;i<oi.length;++i){ei.setTwoSided(!1);var r=oi[i];if(r.wall.standing){var n=r.alive&&r.wall.fracExtend(r),o=r.trailColor;if(r.sfx.wall_decent){var a=.6*r.sfx.wall_decent.brightness;o=ve.nadd(o,[a,a,a])}ei.setColorv(o),ei.setMatrixUniforms(),r.wall.vtxBuf.bind(),Qe.vertexAttribPointer(ei.vertexPositionAttribute,r.wall.vtxBuf.itemSize,Qe.FLOAT,!1,0,0),
Qe.bindBuffer(Qe.ARRAY_BUFFER,null),r.wall.normalsBuf.bind(),Qe.vertexAttribPointer(ei.vertexNormalAttribute,r.wall.normalsBuf.itemSize,Qe.FLOAT,!1,0,0),r.wall.idxRbuf.bind(),Qe.drawElements(Qe.TRIANGLE_STRIP,r.wall.idxRbuf.numItems,Qe.UNSIGNED_SHORT,0),r.wall.idxLbuf.bind(),Qe.drawElements(Qe.TRIANGLE_STRIP,r.wall.idxLbuf.numItems,Qe.UNSIGNED_SHORT,0),r.wall.idxTbuf.bind(),Qe.drawElements(Qe.TRIANGLE_STRIP,r.wall.idxTbuf.numItems,Qe.UNSIGNED_SHORT,0),n&&r.wall.backtrackRawPoint()}r.alive&&(ei.setTwoSided(!0),ye.pushMatrix(),ee(r),r.alive&&(ye.rotateX(-90),ai.bikeFlip&&ye.rotateY(180),ye.scale(ri.model.scale.BIKE_SCALE),
ye.translate([0,2,1.3]),$t(r.model,r.modelColor)),ye.popMatrix())}for(var i=0;i<oi.length;++i){var r=oi[i];r.sfx.explode&&(ye.pushMatrix(),ee(r),r.sfx.explode.draw(),ye.popMatrix())}for(var s in ri.bonuses)ri.bonuses[s].draw();u.use(ii),ri.background.draw(),u.use(ei)}function ne(t){var e=t.point,i=t.selDir.move.call(t),r=ri.map.getPiece(t.point);if(void 0!==r)if(r>=1e3){var n=r-1e3;ri.bonuses[n]&&ri.bonuses[n].action(t)}else Lt(t,r);return++t.stepCount,ri.map.set(e,t.id+100,t.stepCount),void 0===r&&ri.map.set(t.point,t.id,t.stepCount),{dist:i,collide:r}}function oe(t){for(var e=!1,i=0;i<oi.length;++i){
var r=oi[i];if(r.alive){var n=0;for(Ke.isPaused()||(n=ri.model.scale.BASE_SPEED*Ke.currentLevel.speed*t),r.dNow2Last+=n,r.dNow2Point-=n,r.lastMadeMoves=0;r.dNow2Point<0;){r.ai&&r.ai.moveControl(ri);var o=ne(r);if(r.dNow2Last=-r.dNow2Point,r.dNow2Point+=o.dist,r.lastMvDist=o.dist,e=!0,++r.lastMadeMoves,o.collide)break}r.alive&&!Ke.isPaused()&&(r.curStepFrac=r.dNow2Last/r.lastMvDist),ai.moveUpdate(r),r.lastMadeMoves>1&&Xe("made "+r.lastMadeMoves+" moves elapsed="+t)}for(var a in r.sfx)r.sfx[a]&&(r.sfx[a].advance(t),e=!0)}for(var a in ri.staticDraw)ri.staticDraw[a].advance(t);for(var s in ri.bonuses)ri.bonuses[s].advance(t)||delete ri.bonuses[s];
return(!Ke.isPaused()||Ke._startPause)&&ri.background.advance(t),hi.menuAnim&&hi.menuAnim(t),e}function ae(){WebGLUtils.requestAnimationFrame($e,ae);var t=(new Date).getTime(),e=0;if(0==Ze)return Xe("RESET time"),void(Ze=t);if(e=t-Ze,e>40&&(e=40),Ze=t,M(ni),hi.has3dContent&&hi.draw3d(e),ri.ready&&qe._ready&&ui){oe(e);ui&&re(),We.printFps&&je(e)}}function se(){if(ri.ready&&qe._ready&&ui&&!Ke.isPaused()){var t=ri.bonuses.length>0?.2:3;r(t)&&X()}}function le(t){return(Qe=WebGLUtils.setupWebGL(t,{antialias:!0,stencil:!1,alpha:!0}))?(Qe.viewportWidth=t.width,Qe.viewportHeight=t.height,Qe.clearColor(0,0,0,1),
Qe.clearDepth(1),Qe.blendFunc(Qe.SRC_ALPHA,Qe.ONE_MINUS_SRC_ALPHA),Qe.enable(Qe.DEPTH_TEST),Qe.depthFunc(Qe.LEQUAL),n("init"),!0):!1}function ue(){this.data=[]}function he(t){t!==ui&&(t?(ui=!0,Ze=0):(Qe.viewport(0,0,$e.width,$e.height),Qe.clear(Qe.COLOR_BUFFER_BIT|Qe.DEPTH_BUFFER_BIT),ui=!1))}function de(t,e){var i=20;drawDiv=document.getElementById("canvas-container");var r=Math.round(.94*window.innerHeight/.7/i)*i,n=Math.round(.94*window.innerWidth/i)*i,o=Math.min(r,n);if(o!==$e.width||e){600>o&&(o=600),Qe.viewportWidth=$e.width=si.width=o;var a=.7*o;drawDiv.style.height=a+"px",drawDiv.style.width=o+"px",
Qe.viewportHeight=$e.height=si.height=a,hi.resizeAdjust(si.width,si.height),Xe("canvas resized: "+$e.width+" x "+$e.height)}}function ce(t,e){Qe.bindTexture(Qe.TEXTURE_2D,e),Qe.texImage2D(Qe.TEXTURE_2D,0,Qe.RGBA,Qe.RGBA,Qe.UNSIGNED_BYTE,t),Qe.texParameteri(Qe.TEXTURE_2D,Qe.TEXTURE_MAG_FILTER,Qe.LINEAR),Qe.texParameteri(Qe.TEXTURE_2D,Qe.TEXTURE_MIN_FILTER,Qe.LINEAR),Qe.texParameteri(Qe.TEXTURE_2D,Qe.TEXTURE_WRAP_S,Qe.CLAMP_TO_EDGE),Qe.texParameteri(Qe.TEXTURE_2D,Qe.TEXTURE_WRAP_T,Qe.CLAMP_TO_EDGE)}function pe(){di=Qe.createTexture(),img=new Image,img.onload=function(){ce(img,di)},img.src="img/tex2d.jpg";
}function fe(){Ke.userLivesCount=10}function ge(){if(document.getElementById("shadersFrame").src="shaders.html",$e=document.getElementById("game-canvas"),le($e)){if(si=document.getElementById("ctrl-canvas"),li=si.getContext("2d"),null==li)return void alert("failed creating 2d context");de(null,!0),hi.showStartScreen(li),ei.init(shadersFrame.contentDocument.getElementById("phongFs"),shadersFrame.contentDocument.getElementById("phongVs")),ei.initNormParams(),ii.init(shadersFrame.contentDocument.getElementById("bkgTDtexFs"),shadersFrame.contentDocument.getElementById("bkgVs")),ii.initBkgParams(),u.use(ei),
window.onresize=de,pe(),Qt("models/bikePlayer2.json","inlined","bike",Xt),Qt("models/lifeWheel.json","indexed","life",Xt),qe.explode={ring:{}},B(qe.explode),qe.background={},Zt(qe.background),Ft(),WebGLUtils.requestAnimationFrame($e,ae),setInterval(se,1e3)}}var me={init:function(){this.browser=this.searchString(this.dataBrowser)||"An unknown browser",this.version=this.searchVersion(navigator.userAgent)||this.searchVersion(navigator.appVersion)||"an unknown version",this.OS=this.searchString(this.dataOS)||"an unknown OS"},searchString:function(t){for(var e=0;e<t.length;e++){var i=t[e].string,r=t[e].prop;
if(this.versionSearchString=t[e].versionSearch||t[e].identity,i){if(-1!=i.indexOf(t[e].subString))return t[e].identity}else if(r)return t[e].identity}},searchVersion:function(t){var e=t.indexOf(this.versionSearchString);if(-1!=e)return parseFloat(t.substring(e+this.versionSearchString.length+1))},dataBrowser:[{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera"},{string:navigator.vendor,
subString:"iCab",identity:"iCab"},{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}],dataOS:[{string:navigator.platform,subString:"Win",
identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.userAgent,subString:"iPhone",identity:"iPhone/iPod"},{string:navigator.platform,subString:"Linux",identity:"Linux"}]};me.init(),WebGLUtils=function(){var t,e,i=function(t,e){return'<div style="background-color: #EEE; width: 100%; height: 100%; text-align:center;" class="inframe"><div style="width: 80%; height: 100%; margin: auto; display:table;"><p style="font:bold 28px sans-serif; margin:10px 0 10px 0">'+t+'</p><div style="font-size: 18px; margin:0">'+e+"</div></div></div>"},r="Your browser does not support WebGL",n="http://www.google.com/chrome",o="http://getfirefox.com",a="<div style='float:left; width:150px'><a href='"+o+"' target=_blank><img src='img/firefox_icon128.png'><br/>Get firefox</a></div>",s="<div style='float:left; width:150px'><a href='"+n+"' target=_blank><img src='img/chromelogo128.png'><br/>Get chrome</a></div>",l='<div style="margin:10px auto 0 auto; display:table;">'+a+s+"</div>",u='<div style="margin:10px auto 0 auto; display:table;">'+s+"</div>",h='<div style="margin:10px auto 0 auto; display:table;">'+a+"</div>",d="To play CycleBlob please use <a href='"+n+"' target=_blank>Google Chrome</a> or <a href='"+o+"' target=_blank>Mozilla Firefox</a>",c='<iframe title="YouTube video player" width="640" height="390" src="http://www.youtube.com/embed/amFozFKhmxc?rel=0" frameborder="0" allowfullscreen></iframe>',p="Check this website: <a href='http://get.webgl.org/'>http://get.webgl.org/</a> for more information.",f="<br/>"+p+"<br/><br/>"+c,g="Firefox "+me.version+" does not supprot WebGL<br/>To play CycleBlob please upgrade to the latest version of <a href='"+o+"' target=_blank>Firefox</a> (4.0 and above) or get <a href='"+n+"' target=_blank>Google Chrome</a><br/>"+l+f,m="Chrome "+me.version+" does not support WebGL<br/>To play CycleBlob please upgrade to the latest version of <a href='"+n+"' target=_blank>Chrome</a> (9.0 and above) or get <a href='"+o+"' target=_blank>Mozilla Firefox</a><br/>"+l+f,v=d+f,w="Microsoft Internet Explorer (MSIE) does not support WebGL yet.<br/>"+d+"<br/>"+l+f,x="Your version of Firefox ("+me.version+") is supposed to support WebGL but an error occured while trying to use it</br>Things you might try to do to fix this:</br><ul style='text-align:left; margin-bottom:0'><li>Write in the address 'about:config' in the address bar and press Enter. Filter for 'WebGL' in the config page and make sure it is not disabled.</li><li>In the same page (about:config), set 'webgl.force-enabled' to 'true'</li><li>Check for messages or errors at the very bottom of the 'about:support' page</li><li>Update the display drivers of your computer. Some older drivers are known not to work properly.</li><li>"+p+"</li><li>Try <a href='"+n+"' target=_blank>Google Chrome</a>.</li></ul>"+u+"<br/>"+c,y="Your version of Chrome ("+me.version+") is supposed to support WebGL but an error occured while trying to use it</br>Things you might try to do to fix this:</br><ul style='text-align:left; margin-bottom:0'><li>Update the display drivers of your computer. Some older drivers are known not to work properly.</li><li>Write in the address 'about:gpu' in the address bar, press Enter and see if you detect some sort of error which prevents using hardware acceleration</li><li>"+p+"</li><li>Try <a href='"+o+"' target=_blank>Mozilla Firefox</a>.</li></ul>"+h+"<br/>"+c,b="An Unknown error occured while initializing WebGL",_="Your browser appears to support WebGL but there was an error using it<br/>"+p+"<br/>"+c,S=function(t,e,n){
function o(){var e=t.parentNode;if(e){var n;n="Explorer"==me.browser?i(r,w):"Firefox"==me.browser?me.version<4?i(r,g):i(b,x):"Chrome"==me.browser?me.version<9?i(r,m):i(b,y):window.WebGLRenderingContext?i(b,_):i(r,v),e.innerHTML=n,e.style.height=null}}n=n||o,t.addEventListener&&t.addEventListener("webglcontextcreationerror",function(t){n(t.statusMessage)},!1);var a=M(t,e);return a||n(),a},M=function(t,e){for(var i=["webgl","experimental-webgl","webkit-3d","moz-webgl"],r=null,n=0;n<i.length;++n){try{r=t.getContext(i[n],e)}catch(t){}if(r)break}return r},D=function(){return e||(e=function(){for(var t=["animationTime","webkitAnimationTime","mozAnimationTime","oAnimationTime","msAnimationTime"],e=0;e<t.length;++e){
var i=t[e];if(window[i])return function(){return window[i]}}return function(){return(new Date).getTime()}}()),e()},E=function(e,i){t||(t=function(){for(var t=["requestAnimationFrame","webkitRequestAnimationFrame","mozRequestAnimationFrame","oRequestAnimationFrame","msRequestAnimationFrame"],e=0;e<t.length;++e){var i=t[e];if(window[i])return function(t){return function(e,i){window[t].call(window,i,e)}}(i)}return function(t,e){window.setTimeout(e,1e3/70)}}()),t(e,i)};return{animationTime:D,create3DContext:M,requestAnimationFrame:E,setupWebGL:S}}(),glMatrixArrayType="undefined"!=typeof Float32Array?Float32Array:"undefined"!=typeof WebGLFloatArray?WebGLFloatArray:Array;
var ve={};ve.create=function(t){var e=new glMatrixArrayType(3);return t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2]),e},ve.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},ve.add=function(t,e,i){return i&&t!=i?(i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i):(t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t)},ve.subtract=function(t,e,i){return i&&t!=i?(i[0]=t[0]-e[0],i[1]=t[1]-e[1],i[2]=t[2]-e[2],i):(t[0]-=e[0],t[1]-=e[1],t[2]-=e[2],t)},ve.negate=function(t,e){return e||(e=t),e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},ve.scale=function(t,e,i){return i&&t!=i?(i[0]=t[0]*e,i[1]=t[1]*e,i[2]=t[2]*e,i):(t[0]*=e,t[1]*=e,t[2]*=e,
t)},ve.normalize=function(t,e){e||(e=t);var i=t[0],r=t[1],n=t[2],o=Math.sqrt(i*i+r*r+n*n);return o?1==o?(e[0]=i,e[1]=r,e[2]=n,e):(o=1/o,e[0]=i*o,e[1]=r*o,e[2]=n*o,e):(e[0]=0,e[1]=0,e[2]=0,e)},ve.cross=function(t,e,i){i||(i=t);var r=t[0],n=t[1];t=t[2];var o=e[0],a=e[1];return e=e[2],i[0]=n*e-t*a,i[1]=t*o-r*e,i[2]=r*a-n*o,i},ve.length=function(t){var e=t[0],i=t[1];return t=t[2],Math.sqrt(e*e+i*i+t*t)},ve.dot=function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},ve.direction=function(t,e,i){i||(i=t);var r=t[0]-e[0],n=t[1]-e[1];return t=t[2]-e[2],(e=Math.sqrt(r*r+n*n+t*t))?(e=1/e,i[0]=r*e,i[1]=n*e,i[2]=t*e,
i):(i[0]=0,i[1]=0,i[2]=0,i)},ve.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+"]"};var we={};we.create=function(t){var e=new glMatrixArrayType(9);return t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9]),e},we.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},we.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t},we.toMat4=function(t,e){return e||(e=xe.create()),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=0,e[4]=t[3],e[5]=t[4],e[6]=t[5],
e[7]=0,e[8]=t[6],e[9]=t[7],e[10]=t[8],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},we.str=function(t){return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+"]"};var xe={};xe.create=function(t){var e=new glMatrixArrayType(16);return t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e},xe.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],
e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},xe.identity=function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},xe.transpose=function(t,e){if(!e||t==e){var i=t[1],r=t[2],n=t[3],o=t[6],a=t[7],s=t[11];return t[1]=t[4],t[2]=t[8],t[3]=t[12],t[4]=i,t[6]=t[9],t[7]=t[13],t[8]=r,t[9]=o,t[11]=t[14],t[12]=n,t[13]=a,t[14]=s,t}return e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15],e},xe.determinant=function(t){
var e=t[0],i=t[1],r=t[2],n=t[3],o=t[4],a=t[5],s=t[6],l=t[7],u=t[8],h=t[9],d=t[10],c=t[11],p=t[12],f=t[13],g=t[14];return t=t[15],p*h*s*n-u*f*s*n-p*a*d*n+o*f*d*n+u*a*g*n-o*h*g*n-p*h*r*l+u*f*r*l+p*i*d*l-e*f*d*l-u*i*g*l+e*h*g*l+p*a*r*c-o*f*r*c-p*i*s*c+e*f*s*c+o*i*g*c-e*a*g*c-u*a*r*t+o*h*r*t+u*i*s*t-e*h*s*t-o*i*d*t+e*a*d*t},xe.inverse=function(t,e){e||(e=t);var i=t[0],r=t[1],n=t[2],o=t[3],a=t[4],s=t[5],l=t[6],u=t[7],h=t[8],d=t[9],c=t[10],p=t[11],f=t[12],g=t[13],m=t[14],v=t[15],w=i*s-r*a,x=i*l-n*a,y=i*u-o*a,b=r*l-n*s,_=r*u-o*s,S=n*u-o*l,M=h*g-d*f,D=h*m-c*f,E=h*v-p*f,A=d*m-c*g,T=d*v-p*g,R=c*v-p*m,I=1/(w*R-x*T+y*A+b*E-_*D+S*M);
return e[0]=(s*R-l*T+u*A)*I,e[1]=(-r*R+n*T-o*A)*I,e[2]=(g*S-m*_+v*b)*I,e[3]=(-d*S+c*_-p*b)*I,e[4]=(-a*R+l*E-u*D)*I,e[5]=(i*R-n*E+o*D)*I,e[6]=(-f*S+m*y-v*x)*I,e[7]=(h*S-c*y+p*x)*I,e[8]=(a*T-s*E+u*M)*I,e[9]=(-i*T+r*E-o*M)*I,e[10]=(f*_-g*y+v*w)*I,e[11]=(-h*_+d*y-p*w)*I,e[12]=(-a*A+s*D-l*M)*I,e[13]=(i*A-r*D+n*M)*I,e[14]=(-f*b+g*x-m*w)*I,e[15]=(h*b-d*x+c*w)*I,e},xe.toMat3=function(t,e){return e||(e=we.create()),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},xe.toInverseMat3=function(t,e){var i=t[0],r=t[1],n=t[2],o=t[4],a=t[5],s=t[6],l=t[8],u=t[9],h=t[10],d=h*a-s*u,c=-h*o+s*l,p=u*o-a*l,f=i*d+r*c+n*p;
return f?(f=1/f,e||(e=we.create()),e[0]=d*f,e[1]=(-h*r+n*u)*f,e[2]=(s*r-n*a)*f,e[3]=c*f,e[4]=(h*i-n*l)*f,e[5]=(-s*i+n*o)*f,e[6]=p*f,e[7]=(-u*i+r*l)*f,e[8]=(a*i-r*o)*f,e):null},xe.multiply=function(t,e,i){i||(i=t);var r=t[0],n=t[1],o=t[2],a=t[3],s=t[4],l=t[5],u=t[6],h=t[7],d=t[8],c=t[9],p=t[10],f=t[11],g=t[12],m=t[13],v=t[14];t=t[15];var w=e[0],x=e[1],y=e[2],b=e[3],_=e[4],S=e[5],M=e[6],D=e[7],E=e[8],A=e[9],T=e[10],R=e[11],I=e[12],P=e[13],L=e[14];return e=e[15],i[0]=w*r+x*s+y*d+b*g,i[1]=w*n+x*l+y*c+b*m,i[2]=w*o+x*u+y*p+b*v,i[3]=w*a+x*h+y*f+b*t,i[4]=_*r+S*s+M*d+D*g,i[5]=_*n+S*l+M*c+D*m,i[6]=_*o+S*u+M*p+D*v,
i[7]=_*a+S*h+M*f+D*t,i[8]=E*r+A*s+T*d+R*g,i[9]=E*n+A*l+T*c+R*m,i[10]=E*o+A*u+T*p+R*v,i[11]=E*a+A*h+T*f+R*t,i[12]=I*r+P*s+L*d+e*g,i[13]=I*n+P*l+L*c+e*m,i[14]=I*o+P*u+L*p+e*v,i[15]=I*a+P*h+L*f+e*t,i},xe.multiplyVec3=function(t,e,i){i||(i=e);var r=e[0],n=e[1];return e=e[2],i[0]=t[0]*r+t[4]*n+t[8]*e+t[12],i[1]=t[1]*r+t[5]*n+t[9]*e+t[13],i[2]=t[2]*r+t[6]*n+t[10]*e+t[14],i},xe.multiplyVec4=function(t,e,i){i||(i=e);var r=e[0],n=e[1],o=e[2];return e=e[3],i[0]=t[0]*r+t[4]*n+t[8]*o+t[12]*e,i[1]=t[1]*r+t[5]*n+t[9]*o+t[13]*e,i[2]=t[2]*r+t[6]*n+t[10]*o+t[14]*e,i[3]=t[3]*r+t[7]*n+t[11]*o+t[15]*e,i},xe.translate=function(t,e,i){
var r=e[0],n=e[1];if(e=e[2],!i||t==i)return t[12]=t[0]*r+t[4]*n+t[8]*e+t[12],t[13]=t[1]*r+t[5]*n+t[9]*e+t[13],t[14]=t[2]*r+t[6]*n+t[10]*e+t[14],t[15]=t[3]*r+t[7]*n+t[11]*e+t[15],t;var o=t[0],a=t[1],s=t[2],l=t[3],u=t[4],h=t[5],d=t[6],c=t[7],p=t[8],f=t[9],g=t[10],m=t[11];return i[0]=o,i[1]=a,i[2]=s,i[3]=l,i[4]=u,i[5]=h,i[6]=d,i[7]=c,i[8]=p,i[9]=f,i[10]=g,i[11]=m,i[12]=o*r+u*n+p*e+t[12],i[13]=a*r+h*n+f*e+t[13],i[14]=s*r+d*n+g*e+t[14],i[15]=l*r+c*n+m*e+t[15],i},xe.scale=function(t,e,i){var r=e[0],n=e[1];return e=e[2],i&&t!=i?(i[0]=t[0]*r,i[1]=t[1]*r,i[2]=t[2]*r,i[3]=t[3]*r,i[4]=t[4]*n,i[5]=t[5]*n,i[6]=t[6]*n,
i[7]=t[7]*n,i[8]=t[8]*e,i[9]=t[9]*e,i[10]=t[10]*e,i[11]=t[11]*e,i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15],i):(t[0]*=r,t[1]*=r,t[2]*=r,t[3]*=r,t[4]*=n,t[5]*=n,t[6]*=n,t[7]*=n,t[8]*=e,t[9]*=e,t[10]*=e,t[11]*=e,t)},xe.rotate=function(t,e,i,r){var n=i[0],o=i[1];i=i[2];var a=Math.sqrt(n*n+o*o+i*i);if(!a)return null;1!=a&&(a=1/a,n*=a,o*=a,i*=a);var s=Math.sin(e),l=Math.cos(e),u=1-l;e=t[0],a=t[1];var h=t[2],d=t[3],c=t[4],p=t[5],f=t[6],g=t[7],m=t[8],v=t[9],w=t[10],x=t[11],y=n*n*u+l,b=o*n*u+i*s,_=i*n*u-o*s,S=n*o*u-i*s,M=o*o*u+l,D=i*o*u+n*s,E=n*i*u+o*s;return n=o*i*u-n*s,o=i*i*u+l,r?t!=r&&(r[12]=t[12],
r[13]=t[13],r[14]=t[14],r[15]=t[15]):r=t,r[0]=e*y+c*b+m*_,r[1]=a*y+p*b+v*_,r[2]=h*y+f*b+w*_,r[3]=d*y+g*b+x*_,r[4]=e*S+c*M+m*D,r[5]=a*S+p*M+v*D,r[6]=h*S+f*M+w*D,r[7]=d*S+g*M+x*D,r[8]=e*E+c*n+m*o,r[9]=a*E+p*n+v*o,r[10]=h*E+f*n+w*o,r[11]=d*E+g*n+x*o,r},xe.rotateX=function(t,e,i){var r=Math.sin(e);e=Math.cos(e);var n=t[4],o=t[5],a=t[6],s=t[7],l=t[8],u=t[9],h=t[10],d=t[11];return i?t!=i&&(i[0]=t[0],i[1]=t[1],i[2]=t[2],i[3]=t[3],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):i=t,i[4]=n*e+l*r,i[5]=o*e+u*r,i[6]=a*e+h*r,i[7]=s*e+d*r,i[8]=n*-r+l*e,i[9]=o*-r+u*e,i[10]=a*-r+h*e,i[11]=s*-r+d*e,i},xe.rotateY=function(t,e,i){
var r=Math.sin(e);e=Math.cos(e);var n=t[0],o=t[1],a=t[2],s=t[3],l=t[8],u=t[9],h=t[10],d=t[11];return i?t!=i&&(i[4]=t[4],i[5]=t[5],i[6]=t[6],i[7]=t[7],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):i=t,i[0]=n*e+l*-r,i[1]=o*e+u*-r,i[2]=a*e+h*-r,i[3]=s*e+d*-r,i[8]=n*r+l*e,i[9]=o*r+u*e,i[10]=a*r+h*e,i[11]=s*r+d*e,i},xe.rotateZ=function(t,e,i){var r=Math.sin(e);e=Math.cos(e);var n=t[0],o=t[1],a=t[2],s=t[3],l=t[4],u=t[5],h=t[6],d=t[7];return i?t!=i&&(i[8]=t[8],i[9]=t[9],i[10]=t[10],i[11]=t[11],i[12]=t[12],i[13]=t[13],i[14]=t[14],i[15]=t[15]):i=t,i[0]=n*e+l*r,i[1]=o*e+u*r,i[2]=a*e+h*r,i[3]=s*e+d*r,i[4]=n*-r+l*e,
i[5]=o*-r+u*e,i[6]=a*-r+h*e,i[7]=s*-r+d*e,i},xe.frustum=function(t,e,i,r,n,o,a){a||(a=xe.create());var s=e-t,l=r-i,u=o-n;return a[0]=2*n/s,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2*n/l,a[6]=0,a[7]=0,a[8]=(e+t)/s,a[9]=(r+i)/l,a[10]=-(o+n)/u,a[11]=-1,a[12]=0,a[13]=0,a[14]=-(o*n*2)/u,a[15]=0,a},xe.perspective=function(t,e,i,r,n){return t=i*Math.tan(t*Math.PI/360),e=t*e,xe.frustum(-e,e,-t,t,i,r,n)},xe.ortho=function(t,e,i,r,n,o,a){a||(a=xe.create());var s=e-t,l=r-i,u=o-n;return a[0]=2/s,a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/l,a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/u,a[11]=0,a[12]=-(t+e)/s,a[13]=-(r+i)/l,a[14]=-(o+n)/u,
a[15]=1,a},xe.lookAt=function(t,e,i,r){r||(r=xe.create());var n=t[0],o=t[1];t=t[2];var a=i[0],s=i[1],l=i[2];i=e[1];var u=e[2];if(n==e[0]&&o==i&&t==u)return xe.identity(r);var h,d,c,p;return i=n-e[0],u=o-e[1],e=t-e[2],p=1/Math.sqrt(i*i+u*u+e*e),i*=p,u*=p,e*=p,h=s*e-l*u,l=l*i-a*e,a=a*u-s*i,(p=Math.sqrt(h*h+l*l+a*a))?(p=1/p,h*=p,l*=p,a*=p):a=l=h=0,s=u*a-e*l,d=e*h-i*a,c=i*l-u*h,(p=Math.sqrt(s*s+d*d+c*c))?(p=1/p,s*=p,d*=p,c*=p):c=d=s=0,r[0]=h,r[1]=s,r[2]=i,r[3]=0,r[4]=l,r[5]=d,r[6]=u,r[7]=0,r[8]=a,r[9]=c,r[10]=e,r[11]=0,r[12]=-(h*n+l*o+a*t),r[13]=-(s*n+d*o+c*t),r[14]=-(i*n+u*o+e*t),r[15]=1,r},xe.str=function(t){
return"["+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+"]"},quat4={},quat4.create=function(t){var e=new glMatrixArrayType(4);return t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]),e},quat4.set=function(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},ve.linearMix=function(t,e,i,r){r||(r=ve.create());var n=1-i;return r[0]=t[0]*i+e[0]*n,r[1]=t[1]*i+e[1]*n,r[2]=t[2]*i+e[2]*n,r},ve.x=function(t,e){var i=ve.create(t);return ve.scale(i,e)},ve.ncross=function(t,e){var i=ve.create(t);return ve.cross(i,e);
},ve.nsubtract=function(t,e){var i=ve.create(t);return ve.subtract(i,e)},ve.nadd=function(t,e){var i=ve.create(t);return ve.add(i,e)},ve.nadd3=function(t,e){var i=ve.create(t);return ve.add(i,e)},ve.nnegate=function(t){var e=ve.create(t);return ve.negate(e)},ve.distance=function(t,e){var i=t[0]-e[0],r=t[1]-e[1],n=t[2]-e[2];return Math.sqrt(i*i+r*r+n*n)},xe.nidentity=function(){return xe.identity(xe.create())},s.prototype.pushMatrix=function(t){this.stackTop>=this.stack.length&&this.stack.push(xe.create()),t?(xe.set(t,this.stack[this.stackTop]),xe.set(t,this.current)):xe.set(this.current,this.stack[this.stackTop]),
++this.stackTop},s.prototype.popMatrix=function(){if(0===this.stackTop)throw"Invalid popMatrix!";return--this.stackTop,xe.set(this.stack[this.stackTop],this.current),this.current},s.prototype.loadIdentity=function(){xe.identity(this.current)},s.prototype.load=function(t){xe.set(t,this.current)},s.prototype.multMatrix=function(t){xe.multiply(this.current,t)},s.prototype.translate=function(t){xe.translate(this.current,t)},s.prototype.scale=function(t){xe.scale(this.current,[t,t,t])},s.prototype.rotate=function(t,e){xe.rotate(this.current,o(t),e)},s.prototype.rotateX=function(t){xe.rotateX(this.current,o(t));
},s.prototype.rotateY=function(t){xe.rotateY(this.current,o(t))},s.prototype.rotateZ=function(t){xe.rotateZ(this.current,o(t))},s.prototype.perspective=function(t,e,i,r){xe.perspective(t,e,i,r,this.current)};var ye=new s,be=new s;u.prototype.init=function(t,e){var i=l(Qe,t),r=l(Qe,e);return this.prog=Qe.createProgram(),Qe.attachShader(this.prog,r),Qe.attachShader(this.prog,i),Qe.linkProgram(this.prog),Qe.getProgramParameter(this.prog,Qe.LINK_STATUS)?void 0:(alert("Could not initialise shaders"),null)},u.prototype.enableArrs=function(t){t?(Qe.enableVertexAttribArray(this.vertexPositionAttribute),
void 0!==this.vertexNormalAttribute&&Qe.enableVertexAttribArray(this.vertexNormalAttribute)):(Qe.disableVertexAttribArray(this.vertexPositionAttribute),void 0!==this.vertexNormalAttribute&&Qe.disableVertexAttribArray(this.vertexNormalAttribute))},u.prototype.initBkgParams=function(){Qe.useProgram(this.prog),this.vertexPositionAttribute=Qe.getAttribLocation(this.prog,"aVertexPosition"),this.pMatrixUniform=Qe.getUniformLocation(this.prog,"uPMatrix"),this.mvMatrixUniform=Qe.getUniformLocation(this.prog,"uMVMatrix"),this.timeUniform=Qe.getUniformLocation(this.prog,"time"),this.textureUniform=Qe.getUniformLocation(this.prog,"noisef");
},u.prototype.initNormParams=function(){Qe.useProgram(this.prog),this.vertexPositionAttribute=Qe.getAttribLocation(this.prog,"aVertexPosition"),this.vertexNormalAttribute=Qe.getAttribLocation(this.prog,"aVertexNormal"),this.pMatrixUniform=Qe.getUniformLocation(this.prog,"uPMatrix"),this.mvMatrixUniform=Qe.getUniformLocation(this.prog,"uMVMatrix"),this.useLightingUniform=Qe.getUniformLocation(this.prog,"uUseLighting"),this.ambientColorUniform=Qe.getUniformLocation(this.prog,"uAmbientColor"),this.pointLightingLocationUniform=Qe.getUniformLocation(this.prog,"uPointLightingLocation"),this.pointLightingSpecularColorUniform=Qe.getUniformLocation(this.prog,"uPointLightingSpecularColor"),
this.pointLightingDiffuseColorUniform=Qe.getUniformLocation(this.prog,"uPointLightingDiffuseColor"),this.globColorUniform=Qe.getUniformLocation(this.prog,"uGlobColor"),this.twoSidedUniform=Qe.getUniformLocation(this.prog,"uTwoSided")},u.current=null,u.use=function(t){u.current!==t&&(null!==u.current&&u.current.enableArrs(!1),null===t||void 0===t?(Qe.useProgram(null),u.current=null):(Qe.useProgram(t.prog),u.current=t,null!==u.current&&u.current.enableArrs(!0)))},u.prototype.setMatrixUniforms=function(){Qe.uniformMatrix4fv(this.pMatrixUniform,!1,be.current),Qe.uniformMatrix4fv(this.mvMatrixUniform,!1,ye.current);
},u.prototype.setColor=function(t,e,i){Qe.uniform4f(this.globColorUniform,t,e,i,1)},u.prototype.setColor4=function(t,e,i,r){Qe.uniform4f(this.globColorUniform,t,e,i,r)},u.prototype.setColorv=function(t){Qe.uniform4f(this.globColorUniform,t[0],t[1],t[2],1)},u.prototype.setColor4v=function(t){Qe.uniform4f(this.globColorUniform,t[0],t[1],t[2],t[3])},u.prototype.setTwoSided=function(t){Qe.uniform1i(this.twoSidedUniform,t)},u.prototype.setUseLight=function(t){Qe.uniform1i(this.useLightingUniform,t)},u.prototype.enableNormals=function(t){t?Qe.enableVertexAttribArray(this.vertexNormalAttribute):Qe.disableVertexAttribArray(this.vertexNormalAttribute);
},u.prototype.setTime=function(t){Qe.uniform1f(this.timeUniform,t)},h.Data=function(t,e,i,r){if(4!=arguments.length)throw new Error("GLBuffer.Data needs 4 arguments");var n=new h(t);return Qe.bindBuffer(n.target,n.buf),Qe.bufferData(n.target,e,i),n.itemSize=r,n.numItems=e.length/r,e instanceof Float32Array?n.type=Qe.FLOAT:e instanceof Uint32Array?n.type=Qe.UNSIGNED_INT:e instanceof Int32Array?n.type=Qe.INT:e instanceof Uint16Array?n.type=Qe.UNSIGNED_SHORT:e instanceof Int16Array?n.type=Qe.SHORT:e instanceof Uint8Array?n.type=Qe.UNSIGNED_BYTE:e instanceof Int8Array&&(n.type=Qe.BYTE),n},h.Size=function(t,e,i,r,n,o){
if(arguments.length<5)throw new Error("GLBuffer.Size needs 5 or 6 arguments");var a=new h(t);a.itemSize=i,a.numItems=0,a.allocElements=i*r;var s=c()[e];return a.bytesInElement=s.byteSize,Qe.bindBuffer(a.target,a.buf),Qe.bufferData(a.target,a.bytesInElement*i*r,n),o&&(a.record=new s.arrCtor(i*r)),a},h.prototype.append=function(t){if(!this.allocElements)throw new Error("Cannot append to this kind of GLBuffer");if(t.BYTES_PER_ELEMENT!==this.bytesInElement)throw new Error("Cannot append this type of array "+t.toString+" != "+this.bytesInElement);if(this.numItems+t.length>=this.allocElements)return null;
if(Qe.bindBuffer(this.target,this.buf),Qe.bufferSubData(this.target,this.numItems*this.itemSize*this.bytesInElement,t),this.record)for(var e=0;e<t.length;++e)this.record[this.numItems*this.itemSize+e]=t[e];var i=this.numItems;return this.numItems+=t.length/this.itemSize,i},h.prototype.backtrack=function(t){this.numItems-=t,this.numItems=Math.max(this.numItems,0)},h.prototype.bind=function(){Qe.bindBuffer(this.target,this.buf)},h.prototype.rewriteWithRecord=function(){Qe.bindBuffer(this.target,this.buf),Qe.bufferSubData(this.target,0,this.record)};var _e={Left:{name:"Left",opposite:{},leftHand:{},
rightHand:{},move:null},Right:{name:"Right",opposite:{},leftHand:{},rightHand:{},move:null},Up:{name:"Up",opposite:{},leftHand:{},rightHand:{},move:null},Down:{name:"Down",opposite:{},leftHand:{},rightHand:{},move:null}};_e.Left.opposite=_e.Right,_e.Left.leftHand=_e.Down,_e.Left.rightHand=_e.Up,_e.Right.opposite=_e.Left,_e.Right.leftHand=_e.Up,_e.Right.rightHand=_e.Down,_e.Up.opposite=_e.Down,_e.Up.leftHand=_e.Left,_e.Up.rightHand=_e.Right,_e.Down.opposite=_e.Up,_e.Down.leftHand=_e.Right,_e.Down.rightHand=_e.Left,_e.getRelativeDir=function(t,e){return e===_e.Left?t.leftHand:e===_e.Right?t.rightHand:e===_e.Up?t:e===_e.Down?t.opposite:null;
};var Se=[{model:[.2,.22,1],trail:[.1,.1,1],text:"#3939FF",name:"Blue"},{model:[1,.12,.1],trail:[1,.1,.1],text:"#FF1313",name:"Red"},{model:[1,.43,0],trail:[1,.48,0],text:"#FF6701",name:"Orange"},{model:[0,.82,.1],trail:[0,.9,.1],text:"#14A800",name:"Green"},{model:[.74,.1,1],trail:[.71,0,1],text:"#D21DFF",name:"Purple"},{model:[1,.92,.1],trail:[1,.92,.1],text:"#FFE401",name:"Yellow"}];g.prototype.init=function(){this.normal=ri.model.normals[this.point],this.rightHand=ve.ncross(this.forward,this.normal);var t=2*ri.model.vtx.length;this.wall.idxRbuf=h.Size(Qe.ELEMENT_ARRAY_BUFFER,Qe.UNSIGNED_SHORT,1,t,Qe.DYNAMIC_DRAW),
this.wall.idxLbuf=h.Size(Qe.ELEMENT_ARRAY_BUFFER,Qe.UNSIGNED_SHORT,1,t,Qe.DYNAMIC_DRAW),this.wall.idxTbuf=h.Size(Qe.ELEMENT_ARRAY_BUFFER,Qe.UNSIGNED_SHORT,1,t,Qe.DYNAMIC_DRAW);var e=3*ri.model.vtx.length*4;this.wall.vtxBuf=h.Size(Qe.ARRAY_BUFFER,Qe.FLOAT,3,e,Qe.DYNAMIC_DRAW,!0),this.wall.normalsBuf=h.Size(Qe.ARRAY_BUFFER,Qe.FLOAT,3,e,Qe.DYNAMIC_DRAW),this.wall.idxTbuf.append(new Uint16Array([0,2,4,5])),this.postMove(this.eDir),this.ready=!0},f.POINT_DELAY=4,f.prototype.addRawPoint=function(){function t(){for(var t=0,e=1;7>e;++e)d[t++]=arguments[e][0],d[t++]=arguments[e][1],d[t++]=arguments[e][2];
return d}function e(t,e){return c[0]=t,c[1]=e,c}var i=ve.create(),r=ve.create(),n=ve.create(),o=ve.create(),a=ve.create(),s=ve.create(),l=ve.create(),u=ve.create(),h=ve.create(),d=new Float32Array(18),c=new Uint16Array(2);return function(c,p,f,g,m,v){var w=ri.model.scale.WALL_WIDTH,x=ri.model.scale.WALL_HEIGHT;ve.set(v,i),ve.scale(i,p),ve.set(v,r),ve.scale(r,c),ve.set(m,n),ve.add(n,i),ve.set(m,o),ve.negate(o),ve.add(o,r),ai.bikeFlip&&(ve.negate(g,a),g=a),this.normalsBuf.append(t(d,n,n,o,o,g,g)),ve.set(m,s),ve.scale(s,w),ve.add(s,f),ve.scale(i,w),ve.add(s,i),ve.set(m,l),ve.scale(l,-w),ve.add(l,f),
ve.scale(r,w),ve.add(l,r),ve.scale(g,x,i),ve.set(s,u),ve.add(u,i),ve.set(l,h),ve.add(h,i);var y=this.vtxBuf.append(t(d,s,u,l,h,u,h));this.idxRbuf.append(e(y,y+1)),this.idxLbuf.append(e(y+2,y+3)),this.idxTbuf.append(e(y+4,y+5))}}(),f.prototype.addPoint=function(t,e,i){this.pntRecord.push(i.point);var r=ri.model.vtx[i.point],n=ri.model.normals[i.point];this.addRawPoint(t,e,r,n,i.rightHand,i.forward)},f.prototype.backtrackRawPoint=function(){this.vtxBuf.backtrack(6),this.normalsBuf.backtrack(6),this.idxRbuf.backtrack(2),this.idxLbuf.backtrack(2),this.idxTbuf.backtrack(2)},f.prototype.backtrackPoint=function(){
this.pntRecord.pop(),this.backtrackRawPoint()},f.prototype.queuePoint=function(t,e,i){if(0===f.POINT_DELAY)this.addPoint(t,e,i);else if(this.queue.push({la:t,ra:e,playerDummy:{point:i.point,forward:i.forward,rightHand:i.rightHand}}),this.queue.length>f.POINT_DELAY){var r=this.queue.shift();this.addPoint(r.la,r.ra,r.playerDummy)}},f.prototype.queueBacktrack=function(){0===f.POINT_DELAY||0===this.queue.length?this.backtrackPoint():this.queue.pop()},f.prototype.flushQueue=function(){for(;this.queue.length>0;){var t=this.queue.shift();this.addPoint(t.la,t.ra,t.playerDummy)}},f.prototype.deathEnd=function(t){
this.queueBacktrack(),this.queuePoint(-1,-1,t),this.flushQueue()},f.prototype.setWallHeight=function(t){var e=t*ri.model.scale.WALL_HEIGHT;ai.bikeFlip&&(e=-e);for(var i=this.vtxBuf.record,r=this.pntRecord.length,n=0;r>n;++n){var o=ve.x(ri.model.normals[this.pntRecord[n]],e),a=6*n*3,s=ve.create([i[a],i[a+1],i[a+2]]);a=3*(6*n+2);var l=ve.create([i[a],i[a+1],i[a+2]]);s=ve.nadd(s,o),l=ve.nadd(l,o),a=3*(6*n+1),i[a]=s[0],i[a+1]=s[1],i[a+2]=s[2],a=3*(6*n+4),i[a]=s[0],i[a+1]=s[1],i[a+2]=s[2],a=3*(6*n+3),i[a]=l[0],i[a+1]=l[1],i[a+2]=l[2],a=3*(6*n+5),i[a]=l[0],i[a+1]=l[1],i[a+2]=l[2]}this.vtxBuf.rewriteWithRecord();
},f.prototype.fracExtend=function(t){if(0===this.pntRecord.length)return!1;var e,i=this.pntRecord[this.pntRecord.length-1];e=this.queue.length>0?this.queue[0].playerDummy:t;var r=e.point,n=t.curStepFrac,o=ve.linearMix(ri.model.vtx[r],ri.model.vtx[i],n),a=ri.model.normals[r],s=e.rightHand,l=e.forward;return this.addRawPoint(0,0,o,a,s,l),!0},g.prototype.getBikeOrient=function(){var t,e;if(0==this.wall.queue.length)t=this.forward,e=ri.model.normals[this.point];else if(1==this.wall.queue.length){var i=this.wall.queue[0].playerDummy;t=i.forward,e=ri.model.normals[i.point]}else{var r=Math.min(this.wall.queue.length-1,1),i=this.wall.queue[r].playerDummy,n=this.wall.queue[r-1].playerDummy,o=this.curStepFrac;
t=ve.linearMix(i.forward,n.forward,o),e=ve.linearMix(ri.model.normals[i.point],ri.model.normals[n.point],o)}return{normal:e,forward:t}};var Me={rightHand:{4:1,3:1,5:1,6:1},forward:{4:2,3:1,5:2,6:3},leftHand:{4:3,3:2,5:4,6:5},back:{4:0,3:0,5:0,6:0}};g.prototype.preMove=function(t){var e;t===this.eDir.rightHand?(this.wall.queueBacktrack(),this.wall.queuePoint(1,-1,this),this.wall.flushQueue(),this.turnCallback&&this.turnCallback(!1),e=Me.rightHand):t===this.eDir.leftHand?(this.wall.queueBacktrack(),this.wall.queuePoint(-1,1,this),this.wall.flushQueue(),this.turnCallback&&this.turnCallback(!0),e=Me.leftHand):e=Me.forward;
var i=v(this.point,e,this.last.point),r=ve.nsubtract(ri.model.vtx[i],ri.model.vtx[this.point]),n=ri.model.nei[this.point].d[i];return this.last={point:this.point,normal:this.normal,upDir:this.upDir,forward:this.forward},this.point=i,this.normal=ri.model.normals[this.point],{tonext:r,dist:n}},g.prototype.postMove=function(t){this.rightHand=ve.ncross(this.forward,this.normal),this.wall.queuePoint(0,0,this),this.eDir=t},g.prototype.moveUp=function(){var t=this.preMove(_e.Up);return this.rightHand=ve.normalize(ve.ncross(t.tonext,this.normal)),this.upDir=ve.normalize(ve.ncross(this.normal,this.rightHand)),
this.forward=this.upDir,this.postMove(_e.Up),t.dist},g.prototype.moveDown=function(){var t=this.preMove(_e.Down);return this.rightHand=ve.normalize(ve.ncross(this.normal,t.tonext)),this.upDir=ve.normalize(ve.ncross(this.normal,this.rightHand)),this.forward=ve.nnegate(this.upDir),this.postMove(_e.Down),t.dist},g.prototype.moveLeft=function(){var t=this.preMove(_e.Left);return this.upDir=ve.normalize(ve.ncross(t.tonext,this.normal)),this.rightHand=ve.normalize(ve.ncross(this.upDir,this.normal)),this.forward=ve.nnegate(this.rightHand),this.postMove(_e.Left),t.dist},g.prototype.moveRight=function(){
var t=this.preMove(_e.Right);return this.upDir=ve.normalize(ve.ncross(this.normal,t.tonext)),this.rightHand=ve.normalize(ve.ncross(this.upDir,this.normal)),this.forward=this.rightHand,this.postMove(_e.Right),t.dist},_e.Up.move=g.prototype.moveUp,_e.Down.move=g.prototype.moveDown,_e.Right.move=g.prototype.moveRight,_e.Left.move=g.prototype.moveLeft,g.prototype.prettyName=function(){return"<"+this.id+">"+this.name+"</>"};var De={mouseDown:!1,lastMouseX:null,lastMouseY:null,rotationMatrix:xe.nidentity(),currentlyPressedDirs:[],touchX:null,touchY:null,HANDLERS_MENU:1,HANDLERS_3D:2,handlersSet:0};if("undefined"==typeof Ee)var Ee={
DOM_VK_RETURN:13,DOM_VK_ENTER:14,DOM_VK_PAUSE:19,DOM_VK_ESCAPE:27,DOM_VK_SPACE:32,DOM_VK_LEFT:37,DOM_VK_UP:38,DOM_VK_RIGHT:39,DOM_VK_DOWN:40,DOM_VK_0:48,DOM_VK_1:49,DOM_VK_2:50,DOM_VK_3:51,DOM_VK_4:52,DOM_VK_5:53,DOM_VK_6:54,DOM_VK_7:55,DOM_VK_8:56,DOM_VK_9:57,DOM_VK_A:65,DOM_VK_B:66,DOM_VK_C:67,DOM_VK_D:68,DOM_VK_E:69,DOM_VK_F:70,DOM_VK_G:71,DOM_VK_H:72,DOM_VK_I:73,DOM_VK_J:74,DOM_VK_K:75,DOM_VK_L:76,DOM_VK_M:77,DOM_VK_N:78,DOM_VK_O:79,DOM_VK_P:80,DOM_VK_Q:81,DOM_VK_R:82,DOM_VK_S:83,DOM_VK_T:84,DOM_VK_U:85,DOM_VK_V:86,DOM_VK_W:87,DOM_VK_X:88,DOM_VK_Y:89,DOM_VK_Z:90,DOM_VK_F1:112,DOM_VK_F2:113,
DOM_VK_F3:114,DOM_VK_F4:115,DOM_VK_F5:116,DOM_VK_F6:117,DOM_VK_F7:118,DOM_VK_F8:119,DOM_VK_F9:120,DOM_VK_F10:121,DOM_VK_F11:122,DOM_VK_F12:123};Ee._DOM_VK_OPEN_SQUARE=219,Ee._DOM_VK_CLOSE_SQUARE=221;var Ae={};Ae[Ee.DOM_VK_LEFT]=_e.Left,Ae[Ee.DOM_VK_RIGHT]=_e.Right,Ae[Ee.DOM_VK_UP]=_e.Up,Ae[Ee.DOM_VK_DOWN]=_e.Down,Ae[Ee.DOM_VK_W]=_e.Up,Ae[Ee.DOM_VK_A]=_e.Left,Ae[Ee.DOM_VK_S]=_e.Down,Ae[Ee.DOM_VK_D]=_e.Right;var Te=null,Re=null;ve.minwith=function(t,e){e[0]<t[0]&&(t[0]=e[0]),e[1]<t[1]&&(t[1]=e[1]),e[2]<t[2]&&(t[2]=e[2])},ve.maxwith=function(t,e){e[0]>t[0]&&(t[0]=e[0]),e[1]>t[1]&&(t[1]=e[1]),e[2]>t[2]&&(t[2]=e[2]);
},ve.distance=function(t,e){return Math.sqrt((t[0]-e[0])*(t[0]-e[0])+(t[1]-e[1])*(t[1]-e[1])+(t[2]-e[2])*(t[2]-e[2]))};var Ie=100,Pe=.03,Le=40,ke=.015,Ce=[{},{stepsAhead:2},{stepsAhead:5},{stepsAhead:10},{stepsAhead:15},{stepsAhead:20}];N.prototype.turnLeft=function(){this.player.selDir=this.player.eDir.leftHand},N.prototype.turnRight=function(){this.player.selDir=this.player.eDir.rightHand},N.prototype.turnToAvailableSide=function(t,e){if(this.occRight=U(t.toRight),this.occLeft=U(t.toLeft),!this.occRight||!this.occLeft)if(this.occRight||this.occLeft)this.occRight?this.turnLeft():this.occLeft&&this.turnRight();else{
if(e&&this.checkWallHeading(t))return;if(this.checkFarBlocks())return;r(.5)?this.turnLeft():this.turnRight()}},H.prototype.init=function(t,e){return this.last=e,this.point=t,this.count=0,this.ok=!0,this},H.prototype.goRelDir=function(t){var e=this.point;return this.point=v(this.point,t,this.last),this.last=e,U(this.point)?(this.ok=!1,!1):(++this.count,!0)},H.prototype.goForward=function(){return this.goRelDir(Me.forward)},H.prototype.goRight=function(){return this.goRelDir(Me.rightHand)},H.prototype.goLeft=function(){return this.goRelDir(Me.leftHand)},N.prototype.checkWallHeading=function(t){var e=this.player.id,i=ri.map.get(t.toFwd),r=ue.piece(i);
if(!W(r,e))return!1;var n=ue.meta(i),o=this.player.point,a=this.player.last.point;this.look.init(o,a).goLeft(),this.look.goRight();var s=this.look.point;this.look.init(o,a).goRight(),this.look.goLeft();var l=this.look.point,u=ri.map.get(s),h=ri.map.get(l),d=ue.piece(u),c=ue.piece(h),p=ue.meta(u),f=ue.meta(h);return Xe("wall-h "+d+":"+p+" - "+c+":"+f),W(d,e)&&W(c,e)?(n>p?this.turnLeft():this.turnRight(),!0):!1},N.prototype.checkFarBlocks=function(){var t=this.player.point,e=this.player.last.point;this.look.init(t,e).goLeft();var i=V(this.look,this.stepsAhead,1);this.look.init(t,e).goRight();var r=V(this.look,this.stepsAhead,1);
if(i>r)this.turnLeft();else{if(!(r>i))return!1;this.turnRight()}return!0},N.prototype.moveControl=function(t){var e=w(this.player.point,this.player.last.point),i=U(e.toFwd);return i?void this.turnToAvailableSide(e,!0):r(2)?void this.turnToAvailableSide(e,!1):void 0},K.TOTAL_TIME=800,K.RING_MAX_SIZE=1.5,K.SPIKES_TIME=320,K.SPIKES_MAX_SIZE=.8,K.prototype.draw=function(){ye.pushMatrix(),ei.setUseLight(!1),Qe.enable(Qe.BLEND),ye.translate([0,0,1.2*-ri.model.scale.WALL_WIDTH]),ye.scale(ri.model.scale.GLOBAL_SCALE);for(var t=0;t<this.ringsScale.length;++t){var e=this.ringsScale[t];if(!(.1>e||e>K.RING_MAX_SIZE)){
var i=(e-K.RING_MAX_SIZE)/(.2-K.RING_MAX_SIZE);ei.setColor4(1,.6,.1,i),ye.pushMatrix(),ye.scale(e,e,e),this.player===ni&&ye.rotate(90,[1,0,0]),$t(qe.explode.ring),ye.popMatrix()}}this.showSpikes&&(ye.scale(this.spikesScale,this.spikesScale,this.spikesScale),ei.setColor(1,.6+this.spikesScale,this.spikesScale),this.player===ni&&ye.rotate(90,[1,0,0]),$t(qe.explode.spikes)),Qe.disable(Qe.BLEND),ei.setUseLight(!0),ye.popMatrix()},K.prototype.advance=function(t){for(var e=0;e<this.ringsScale.length;++e)this.ringsScale[e]+=t*((K.RING_MAX_SIZE+1)/K.TOTAL_TIME);this.spikesScale+=t*(K.SPIKES_MAX_SIZE/K.SPIKES_TIME),
this.elapsed+=t,this.elapsed>K.SPIKES_TIME&&(this.showSpikes=!1),this.elapsed>K.TOTAL_TIME&&(this.player.sfx.explode=null,null!==Ge.handler&&Ge.called===!1&&Ge.handler())},Y.START_DELAY=500,Y.HEIGHT_DELAY=250,Y.DECENT_TIME=900,Y.BRIGHT_TIME=340,Y.DARKEN_TIME=200,Y.prototype.advance=function(t){if(this.elapsed+=t,this.elapsed<=Y.BRIGHT_TIME?this.brightness=this.elapsed*(1/Y.BRIGHT_TIME):this.brightness=Math.max(0,1-(this.elapsed-Y.BRIGHT_TIME)*(1/Y.DARKEN_TIME)),this.elapsed>=Y.HEIGHT_DELAY&&(this.height=1-(this.elapsed-Y.BRIGHT_TIME)*(1/Y.DECENT_TIME),this.height=Math.min(1,Math.max(0,this.height))),
this.height<=0){this.player.sfx.wall_decent=null;var e=this.player.wall;e.standing=!1;for(var i=0;i<e.pntRecord.length-1;++i)ri.map.unset(e.pntRecord[i])}else this.player.wall.setWallHeight(this.height)},Q.prototype.startRemove=function(){this.removeElapsed=0,this.alpha=1},Q.prototype.getColor=function(t){return a(t/360,1,.5)},Q.prototype.draw=function(){ye.pushMatrix(),ye.translate(ri.model.vtx[this.point]);var t=te(this.rightHand,this.normal,this.forward);ye.multMatrix(t);var e=ri.model.scale.BONUS_LIFE;ai.bikeFlip&&(e=-e),ye.translate([0,2.3*e,0]),ye.scale(e*this.inflate),ye.rotateY(this.anglex),
ye.rotateX(this.angley),color=this.getColor(this.anglex),null==this.alpha?ei.setColorv(color):(Qe.enable(Qe.BLEND),ei.setColor4(color[0],color[1],color[2],this.alpha)),$t(qe.life),null!=this.alpha&&Qe.disable(Qe.BLEND),ye.popMatrix()},Q.INFLATE_TIME=500,Q.REMOVE_TIME=500,Q.prototype.advance=function(t){if(Dt.prototype.rotate.call(this,t),this.elapsed<Q.INFLATE_TIME)this.elapsed=Math.min(this.elapsed+t,Q.INFLATE_TIME),this.inflate=this.elapsed*(1/Q.INFLATE_TIME);else if(-1!=this.removeElapsed){this.removeElapsed=Math.min(this.removeElapsed+t,Q.REMOVE_TIME);var e=this.removeElapsed*(1/Q.REMOVE_TIME);
if(this.inflate=1+3*e,this.alpha=1-e,e>=1)return!1}else this.inflate=1;return!0},Q.prototype.action=function(t){t===ni&&(++Ke.userLivesCount,ri.staticDraw.lives.startOneUp());for(var e in this.occupy)ri.map.unset(this.occupy[e]);ri.bonuses[this.index].startRemove(),Ht(t),hi.addMessage(t.prettyName()+" found a life bonus")},j.prototype.getCamera=function(){return this},j.prototype.moveUpdate=function(t){if(t===ni){var e=t.curStepFrac;ve.linearMix(t.normal,t.last.normal,e,this.eye),ve.scale(this.eye,this.eyeDist),ve.linearMix(t.upDir,t.last.upDir,e,this.upDir)}},j.prototype.translateDir=function(t,e){
return t},j.prototype.translateRelativeDir=j.prototype.translateDir,j.prototype.getLight=function(){return this.lightPoint},Z.prototype.getCamera=function(){return this},Z.prototype.moveUpdate=function(t){if(t===ni){var e=t.curStepFrac;ve.linearMix(t.normal,t.last.normal,e,this.toPoint),ve.negate(this.toPoint,this.eye),ve.scale(this.eye,this.centerDist),ve.linearMix(t.upDir,t.last.upDir,e,this.upDir)}},Z.prototype.translateDir=function(t,e){return t===_e.Left||t===_e.Right?t.opposite:t},Z.prototype.translateRelativeDir=Z.prototype.translateDir,Z.prototype.getLight=function(){return this.lightPoint;
},J.prototype.getCamera=function(){return this},J.prototype.moveUpdate=function(t){if(t===ni){var e=t.curStepFrac;ve.linearMix(ri.model.vtx[t.point],ri.model.vtx[t.last.point],e,this.eye),ve.linearMix(t.forward,t.last.forward,e,this.t),ve.scale(this.t,slideval1),ve.add(this.t,this.eye,this.toPoint),ve.linearMix(t.normal,t.last.normal,e,this.upDir),ve.scale(this.upDir,.1,this.t),ve.add(this.eye,this.t)}},J.prototype.translateDir=function(t,e){return _e.getRelativeDir(e.eDir,t)},J.prototype.translateRelativeDir=function(t,e){return t},J.prototype.getLight=function(){return this.lightPoint};var Oe=Math.round;
$.prototype.inside=function(t){return t.x>=this.x&&t.y>=this.y&&t.x<=this.x+this.width&&t.y<=this.y+this.height},$.prototype.expand=function(t){return this.x-=t,this.y-=t,this.height+=2*t,this.width+=2*t,this},$.prototype.expanded=function(t){return new $(this.x-t,this.y-t,this.width+2*t,this.height+2*t)},$.prototype.down=function(t){return this.y+=t,this},$.prototype.xmid=function(){return this.x+Oe(this.width/2)},$.prototype.widen=function(t){return this.x-=Oe(t),this.width+=Oe(2*t),this},ht.prototype.setup2dInputs=function(){document.onkeydown=ot,document.onkeyup=at,si.onmousedown=it,$e.onmousedown=it,
document.onmouseup=rt,document.onmousemove=et,document.onmousewheel=nt,De.handlersSet=De.HANDLERS_MENU,document.body.addEventListener("touchstart",st,!1),document.body.addEventListener("touchmove",lt,!1),document.body.addEventListener("touchend",ut,!1),document.body.addEventListener("touchcancel",ut,!1)},ht.prototype.getCanvasCoord=function(t){return{x:t.layerX,y:t.layerY}},ht.prototype.getWidget=function(t){var e=this.getCanvasCoord(t);return this.wnd.coordWidget(e)},ht.prototype.roundedBoxPathb=function(t,e){this.roundedBoxPath(t.x,t.y,t.width,t.height,e)},ht.prototype.roundedBoxPath=function(t,e,i,r,n){
if(void 0===n)throw"r should be defined";li.beginPath(),li.moveTo(t+n,e),li.arcTo(t+i,e,t+i,e+n,n),li.arcTo(t+i,e+r,t+i-n,e+r,n),li.arcTo(t,e+r,t,e+r-n,n),li.arcTo(t,e,t+n,e,n)},ht.prototype.backgroundRect=function(t){li.clearRect(t.x,t.y,t.width,t.height),void 0!==this.widgetsBackground&&(li.fillStyle=this.widgetsBackground,li.fillRect(t.x,t.y,t.width,t.height))},ht.prototype.drawSelect=function(t,e){if(e){var i=Math.max(t.width,t.height),r=li.createLinearGradient(t.x,t.y,t.x+i/2,t.y+i/2);r.addColorStop(0,"rgba(136,255,19,1.0)"),r.addColorStop(1,"rgba(255,255,0,1.0)"),li.fillStyle=r,hi.roundedBoxPath(t.x,t.y,t.width,t.height,10),
li.fillStyle="black",li.fill(),li.fillStyle=r,li.fill()}else this.backgroundRect(t)},dt.EVENT_PRESS=100,dt.EVENT_MOVE=101,dt.EVENT_RELEASE=102,ct.prototype.draw=function(t){hi.drawSelect(this.box,t),this.group&&this.group.testndraw(),li.fillStyle=pt(this.box);var e="center"==li.textAlign?this.box.x+Oe(.5*this.box.width):this.tx;li.fillText(this.text,e,this.ty),li.lineWidth=2,li.strokeStyle=ft(this.box),li.strokeText(this.text,e,this.ty)},gt.prototype.draw=function(t){hi.drawSelect(this.box,t);var e=this.isOn?this.imgOn:this.imgOff;li.drawImage(e,this.boxImg.x,this.boxImg.y,this.boxImg.width,this.boxImg.height);
},mt.prototype.draw=function(t){hi.drawSelect(this.box,t),this.group&&this.group.testndraw(),null!==this.img&&li.drawImage(this.img,this.boxImg.x,this.boxImg.y,this.boxImg.width,this.boxImg.height)},vt.prototype.draw=function(t){hi.backgroundRect(this.clearBox);var e=Oe(.22*this.box.height);hi.roundedBoxPath(this.box.x,this.box.y+Oe(.5*(this.box.height-e)),this.box.width,e,Oe(.5*e)),li.fillStyle=pt(this.box),li.fill(),li.strokeStyle=ft(this.box),li.lineWidth=2,li.stroke();var i=this.box.x+this.box.width/(this.vmax-this.vmin)*(this.value-this.vmin),r=Oe(.35*hi.en);hi.roundedBoxPath(i-r,this.box.y,2*r,this.box.height,Oe(.7*r)),
li.fill(),li.stroke()},vt.prototype.onevent=function(t){var e=this.vmin+t.x/this.box.width*(this.vmax-this.vmin);e=Math.min(this.vmax,Math.max(this.vmin,e)),e=Oe(e/this.step)*this.step,e!==this.value&&(this.value=e,this.draw(!0),this.valueChanged(e)),t.name===dt.EVENT_PRESS&&(hi.curPage.mouseCaptureWidget=this)},wt.prototype.draw=function(t){hi.backgroundRect(this.clearBox);var e=this.box.x,i=this.box.y,r=this.box.width,n=this.box.height;hi.roundedBoxPath(e,i,r,r,4),li.stroke(),hi.roundedBoxPath(e,i+n-r,r,r,4),li.stroke();var o=n-2*r,a=this.part/this.total,s=a*o,l=o-s;hi.roundedBoxPath(e,i+r+this.h,r,s,4),
li.stroke(),this.workd=s,this.rangeh=l},wt.prototype.updateH=function(t){t=Math.min(this.rangeh,Math.max(0,t)),t!==this.h&&(this.h=t,newvalue=Oe(this.h/this.rangeh*(this.total-this.part)),this.draw(!0),this.valueChanged(newvalue))},wt.prototype.onWheelEvent=function(t){this.updateH(this.h-t.wheelDelta/3)},wt.prototype.onevent=function(t){var e=this.h;if(null!==this.pressY&&(e=this.pressH+(t.y-this.pressY)),t.name===dt.EVENT_PRESS){var i=this.box.width+this.h;t.y>=i&&t.y<=i+this.workd?(hi.curPage.mouseCaptureWidget=this,this.pressY=t.y,this.pressH=this.h):t.y<this.box.width?e-=10:t.y>this.box.height-this.box.width?e+=10:t.y<i?e-=100:e+=100;
}else t.name===dt.EVENT_RELEASE&&(this.pressY=null,this.pressH=null);this.updateH(e)},ht.prototype.blankScr=function(t){t?(li.fillStyle=t,li.fillRect(0,0,li.canvas.width,li.canvas.height)):li.clearRect(0,0,li.canvas.width,li.canvas.height)},yt.prototype.setBox=function(t){this.box=t},yt.prototype.testndraw=function(){this.com.sel===this.id&&(hi.roundedBoxPath(this.box.x,this.box.y,this.box.width,this.box.height,10),li.lineWidth=2,li.fillStyle="rgba(0,0,255,0.2)",li.fill(),li.strokeStyle="#0000FF",li.stroke())},ht.prototype.clearScr=function(){this.curPage={},this.curPage.widgets=[],this.curPage.sel=0,
this.curPage.background=void 0,this.curPage.keyHandler=null,this.curPage.mouseHandler=null,this.curPage.selTextBox=null,this.curPage.mouseCaptureWidget=null,this.curPage.wheelHandlers=[],this.blankScr(),this.curMenuDraw=null,this.curMenuRemake=null,this.wnd=new bt(this.curPage.widgets,null)},ht.prototype.setSelectionTextBox=function(t){var e=t.height;this.curPage.selTextBox=t.expanded(Oe(t.height/4)),this.curPage.selTextBox.th=e},bt.prototype.push=function(t,e){return void 0===e&&this.allwidgets.push(t),this.d.push(t),++this.length,t},bt.prototype.coordWidget=function(t){var e={x:t.x,y:t.y};this.box&&(e.x-=this.box.x,
e.y-=this.box.y-this.translateY);for(var i=0;i<this.length;++i){var r=this.d[i];if(void 0!==r.coordWidget){var n=r.coordWidget(e);if(n)return n}else if(r.box.inside(e))return r}return null},bt.prototype.makeTextButton=function(t,e,i,r,n,o,a){li.measureText(t);return this.push(new ct(t,new $(e,i,n,r),new dt(o,this.allwidgets.length),a))},bt.prototype.makeImgToggleButton=function(t,e,i,r,n,o,a,s,l){return this.push(new gt(t,e,i,r,new $(n,o,s,a),new dt(l,this.allwidgets.length)))},bt.prototype.makeImgButton=function(t,e,i,r,n,o,a,s){return this.push(new mt(t,e,new $(i,r,o,n),new dt(a,this.allwidgets.length),s));
},bt.prototype.makeSlider=function(t,e,i,r,n,o,a,s,l){return this.push(new vt(t,e,i,r,new $(n,o,a,s),new dt(l,this.allwidgets.length)))},bt.prototype.makeScroll=function(t,e,i,r,n,o,a,s){return this.push(new wt(t,e,i,new $(r,n,o,a),new dt(s,this.allwidgets.length)))},bt.prototype.makeContainer=function(t,e,i,r){return this.push(new bt(this.allwidgets,new $(t,e,i,r)),!0)},bt.prototype.draw=function(t){if(0!==this.length){this.box&&(hi.backgroundRect(this.box),hi.roundedBoxPathb(this.box.expanded(7),14),li.strokeStyle=ft(this.box),li.lineWidth=1,li.stroke(),li.save(),hi.roundedBoxPathb(this.box,14),
li.clip(),li.translate(this.box.x,this.box.y-this.translateY));for(var e=0;e<this.length;++e){var i=this.d[e];i.base?i.draw(i.base.index===t):i.draw(t)}this.box&&li.restore()}},ht.prototype.drawWidgets=function(){if(this.wnd.draw(this.curPage.sel),0!=this.curPage.widgets.length){var t=this.curPage.widgets[this.curPage.sel].text;this.curPage.selTextBox&&t&&(this.backgroundRect(this.curPage.selTextBox),li.fillStyle="#ff3c00",li.textAlign="center",this.setMenuFont(this.curPage.selTextBox.th),li.fillText(t,this.curPage.selTextBox.xmid(),this.curPage.selTextBox.y+this.curPage.selTextBox.th),li.textAlign="start");
}};var Fe="rgba(0, 0, 0, 0.8)",Be="rgba(128, 128, 128, 0.7)";ht.prototype.preMenu=function(t){this.setup2dInputs(),this.clearScr(),this.widgetsBackground=t;var e=arguments.callee.caller,i=e.arguments;this.curMenuRemake=function(){e.apply(this,i)}},ht.prototype.setMenuFont=function(t){t||(t=this.texth),li.font="bold "+Oe(t)+"px sans-serif"},ht.prototype.resizeAdjust=function(t,e){this.texth=Oe(42*(t/900)),this.setMenuFont(),this.em=li.measureText("m").width,this.en=li.measureText("n").width,Xe("text height: "+this.texth+" em: "+this.em+" "+this.en),this.drawGameState(!0),this.curMenuRemake&&this.curMenuRemake();
},ht.prototype.showStartScreen=function(){zt(0,We.preloadFirst,null),he(!1),this.preMenu("black");var t=li.canvas.width,e=li.canvas.height,i=(Oe(t/2),Oe(e/2),this.texth),r=this.em;this.setMenuFont();var n=8*r,o=this.wnd.makeTextButton("New game",20,e-6*i,i,n,function(){Xe("NewNew!"),hi.clearScr(),hi.mainMenu=ht.prototype.showStartScreen,Wt(function(){Rt()})});this.wnd.makeTextButton("How to play",20,e-4.3*i,i,n,function(){hi.instructionsScreen()}),this.wnd.makeTextButton("Custom level",20,e-2.6*i,i,n,function(){hi.customLevelScreen()}),this.wnd.makeImgToggleButton(soundOnImg,soundOffImg,"Sound",Ke.soundEnabled,t-50-2*r,e-50-2*r,2.5*r,2.5*r,function(t){
Xe("SetSnd "+t),Ke.enableSound(t)}),this.blankScr("black");var a=titleTextImg;li.drawImage(a,0,0,t,Oe(a.height/a.width*t)),this.drawVersionNum(),We.debug&&(this.curPage.keyHandler=function(t){if(t>=Ee.DOM_VK_F1&&t<=Ee.DOM_VK_F12){var e=t-Ee.DOM_VK_F1;return zt(e,We.preloadFirst,null),Xe("NewNew! "+e),hi.clearScr(),hi.mainMenu=ht.prototype.showStartScreen,Wt(function(){Rt(e)}),!1}return!0}),this.curPage.keyHandler=function(t){return t===Ee.DOM_VK_D?(Ke.isDemo=!0,We.userIndex=-1,o.base.callback(),!1):!0},this.drawWidgets(),Ke.isDemo&&this.curPage.keyHandler(Ee.DOM_VK_D)},ht.prototype.drawVersionNum=function(){
li.textAlign="right",li.fillStyle="#333",li.font="10px sans-serif",li.fillText(We.version,li.canvas.width,10),this.setMenuFont(),li.textAlign="start"},ht.prototype.drawHoverBox=function(t,e,i,r){li.fillStyle=Fe,li.strokeStyle=Be,li.lineWidth=5,this.roundedBoxPath(Oe(t),Oe(e),Oe(i),Oe(r),20),li.fill(),li.stroke()},ht.prototype.levelComplete=function(t,e){this.preMenu(Fe);var i=Oe(li.canvas.width/2),r=Oe(li.canvas.height/2),n=this.en,o=this.texth;Oe(o/2);this.wnd.makeImgButton(againImg,"This one again",i-7*n,r,4*n,4*n,function(){hi.clearScr(),Et(e)}),this.wnd.makeImgButton(menuImg,"Exit game",i-2*n,r,4*n,4*n,function(){
hi.showStartScreen()});var a=this.wnd.makeImgButton(nextImg,"Next level",i+3*n,r,4*n,4*n,function(){return hi.clearScr(),e===Ve.length-1?void this.showStartScreen():void(-1!==t?zt(t+1,We.preloadBatch,function(){Et(t+1)}):hi.customLevelScreen())});this.curPage.sel=2,this.setSelectionTextBox(new $(i-6*n,r+5*n,12*n,.7*o)),this.curMenuDraw=function(){this.setMenuFont(),this.drawHoverBox(i-9*this.en,r-2.5*this.texth,18*this.en,7*o),li.fillStyle="#ff3c00",li.textAlign="center",li.fillText((-1!==t?"Level "+(t+1):"Level")+" Completed!",i,r-this.texth),li.textAlign="start",this.drawWidgets()},this.drawGameState(),
Ke.isDemo&&a.base.callback()},ht.prototype.lifeEndScreen=function(t,e){this.preMenu(Fe);var i=Oe(li.canvas.width/2),r=Oe(li.canvas.height/2),n=this.texth,o=this.en,a=this.wnd.makeImgButton(againImg,"Try again",i-5*o,r,4*o,4*o,function(){hi.clearScr(),-1!==e&&(t=e),Et(t)});this.wnd.makeImgButton(menuImg,"Exit Game",i+1*o,r,4*o,4*o,function(){hi.mainMenu()}),this.setSelectionTextBox(new $(i-6*o,r+5*o,12*o,.7*n)),this.curMenuDraw=function(){this.setMenuFont(),this.drawHoverBox(i-7*o,r-2.5*n,14*o,6.5*n),li.fillStyle="#ff3c00",li.textAlign="center",li.fillText("You crashed!",i,r-40),li.textAlign="start",
this.drawWidgets()},this.drawGameState(),Ke.isDemo&&a.base.callback()},ht.prototype.gameOverScreen=function(t,e){this.preMenu(Fe);var i=Oe(li.canvas.width/2),r=Oe(li.canvas.height/2),n=this.texth,o=this.en,a=this.wnd.makeImgButton(menuImg,"Back to menu",i-2*o,r,4*o,4*o,function(){hi.mainMenu()});this.setSelectionTextBox(new $(i-6*o,r+5*o,12*o,.7*n)),this.curMenuDraw=function(){this.setMenuFont(),this.drawHoverBox(i-7*this.en,r-2.5*n,14*o,6.5*n),li.fillStyle="#ff3c00",li.textAlign="center",li.fillText("Game Over!",i,r-this.texth),li.textAlign="start",this.drawWidgets()},this.drawGameState(),Ke.isDemo&&a.base.callback();
},ht.prototype.verbosePauseScreen=function(){function t(){hi.clearScr(),hi.drawGameState(),Tt(),Ke.setPaused(!1)}this.preMenu(Fe);var e=Oe(li.canvas.width/2),i=Oe(li.canvas.height/2),r=this.en,n=(this.em,this.texth);this.wnd.makeImgButton(resumeImg,"Resume",e-7*r,i,4*r,4*r,function(){t()}),this.wnd.makeImgButton(menuImg,"End game",e-2*r,i,4*r,4*r,function(){Ke.isDemo=!1,hi.mainMenu()}),this.wnd.makeImgToggleButton(soundOnImg,soundOffImg,"Sound",Ke.soundEnabled,e+3*r,i,4*r,4*r,function(t){Xe("SetSnd "+t),Ke.enableSound(t)}),this.setSelectionTextBox(new $(e-6*r,i+5*r,12*r,.7*n)),this.curMenuDraw=function(){
this.setMenuFont(),this.drawHoverBox(e-8*r,i-2.2*n,16*r,6.5*n),li.fillStyle="#ff3c00",li.textAlign="center",li.fillText("Paused",e,i-n),li.textAlign="start",this.drawWidgets(Fe)},this.curPage.keyHandler=function(e){return e===Ee.DOM_VK_ESCAPE?(t(),!1):!0},this.fadeIn()},ht.prototype.fadeIn=function(){si.style.opacity=0,this.menuAnim=function(t){op=parseFloat(si.style.opacity)+.008*t,op>=1&&(op=1,hi.menuAnim=null),si.style.opacity=op,this.drawGameState()}},ht.prototype.loadingScreen=function(t){this.blankScr("black"),this.setup2dInputs(),he(!1);var e=Oe(li.canvas.width/2),i=Oe(li.canvas.height/2);
this.setMenuFont(),li.fillStyle="#ff3c00",li.textAlign="center",li.fillText("Loading... ",e,i),li.textAlign="start",li.fillStyle="rgb(100,0,0)";var r=Oe(e/2),n=this.texth;li.fillRect(r,i+this.texth,2*r,n),li.fillStyle="rgb(200,0,0)",li.fillRect(r+5,i+this.texth+5,2*t*(r-10),n-10)},ht.prototype.instructionsScreen=function(){this.preMenu();var t=li.canvas.width,e=li.canvas.height,i=Oe(t/2),r=(Oe(e/2),this.texth),n=(this.em,this.en),o=instructImg;li.drawImage(o,0,0,t,Oe(o.height/o.width*t));var a=instructHeader,s=Oe(678/o.width*t);li.drawImage(a,i-Oe(s/2),0,s,Oe(a.height/a.width*s)),this.curPage.keyHandler=this.curPage.mouseHandler=function(){
return hi.end3dAbove(),hi.showStartScreen(),window.history.back(),window.onpopstate=null,!1},window.history.pushState("inst","Instructions",""),window.onpopstate=function(){hi.end3dAbove(),hi.showStartScreen(),window.onpopstate=null};var l=Oe(1.5*r);this.render3d=[new _t(new $(1.2*n,.18*e,l,l)),new St(new $(i-2.5*n,.19*e,2*l,l)),new Mt(new $(i-2.5*n,.07*e,2*l,l))],this.start3dAbove()};var Ne={worldSel:new xt(0),numPlayersSel:new xt(2),aiSel:new xt(1),speedSel:100};ht.prototype.customLevelScreen=function(){this.preMenu("black"),he(!1);var t=li.canvas.width,e=li.canvas.height,i=(Oe(t/2),Oe(e/2),this.texth),r=this.em,n=this.en,o=Oe(e/4.2),a=Oe(.8*o),s=Oe(hi.em/4),l=Ne,u=this.wnd.makeContainer(Oe(r-s),Oe(.08*e),Oe(4.8*o+2*s),Oe(.48*e));
u.translateY=0;for(var h=0;h<Ve.length;++h){var d=null;null!==Ve[h].icon&&(d=new Image,d.src=Ve[h].icon,d.onload=function(){hi.drawWidgets()}),u.makeImgButton(d,"",o*(h%5)+s,o*Math.floor(h/5)+s,a,a,function(t){return function(){l.worldSel.sel=t,hi.drawWidgets()}}(h),new yt(l.worldSel,h))}this.blankScr("black"),li.fillStyle="#ff3c00",hi.setMenuFont(.7*i),li.fillText("Select World:",n,Oe(.7*i));var c=Oe(.68*e);li.fillText("Number of Players:",n,c);var p=Oe(.81*e);li.fillText("Difficulty:",n,p);var f=Oe(.94*e);li.fillText("Speed:",n,f),hi.setMenuFont(i),li.textAlign="center";for(var h=1;6>=h;++h)this.wnd.makeTextButton(h,11*n+h*r*1.5,c-.9*i,i,n,function(t){
return function(){l.numPlayersSel.sel=t,hi.drawWidgets()}}(h),new yt(l.numPlayersSel,h));for(var g=[{txt:"easy",d:1},{txt:"medium",d:3},{txt:"hard",d:5}],m=7*n,h=0;h<g.length;++h){var v=g[h],w=n*(v.txt.length+1);this.wnd.makeTextButton(v.txt,m,p-.9*i,i,w,function(t){return function(){l.aiSel.sel=t,hi.drawWidgets()}}(h),new yt(l.aiSel,h)),m+=w+n}var x=new $(.69*t,.88*e,4.5*n,i),y=(this.wnd.makeSlider(50,300,5,Ne.speedSel,6*n,.89*e,.5*t,1.1*i,function(t){hi.backgroundRect(x),li.fillStyle="#ff3c00",li.textAlign="right",li.fillText(t+"%",x.x+x.width,x.y+i-1),li.textAlign="center",Ne.speedSel=t}),this.wnd.makeScroll(400,200,0,u.drawScroll.x,u.drawScroll.y,30,u.drawScroll.height,function(t){
u.translateY=t,hi.drawWidgets()}));hi.curPage.wheelHandlers=[{box:u.box,handler:function(t){y.onWheelEvent(t)}}],this.wnd.makeImgButton(menuImg,"Exit game",t-5*n,e-10*n,4*n,4*n,function(){hi.showStartScreen(),window.history.back(),window.onpopstate=null}),this.wnd.makeImgButton(nextImg,"Next level",t-5*n,e-5*n,4*n,4*n,function(){hi.clearScr(),worldLvl=l.worldSel.sel,zt(worldLvl,We.preloadBatch,function(){Ke.currentLevelNum=-1,Ke.userLivesCount=3,hi.mainMenu=ht.prototype.customLevelScreen,li.textAlign="start",Et({worldModel:Ve[worldLvl].worldModel,view:Ve[worldLvl].view,numPlayers:l.numPlayersSel.sel,
ai:g[l.aiSel.sel].d,speed:Ne.speedSel/100})})}),this.curPage.keyHandler=function(t){return t===Ee.DOM_VK_ESCAPE?(hi.showStartScreen(),window.history.back(),window.onpopstate=null,!1):!0},window.history.pushState("custom","Custom Level",""),window.onpopstate=function(){hi.showStartScreen(),window.onpopstate=null},hi.setMenuFont(i),li.textAlign="center",this.drawWidgets()},_t.prototype.draw=function(){Qe.viewport(this.box.x,this.box.y,this.box.width,this.box.height),be.load(xe.ortho(-1,1,1,-1,.1,100)),ye.pushMatrix(),ye.translate([0,0,-10]),ye.scale(.3),ye.rotateX(this.anglex),ye.rotateZ(this.angley),
ei.setColorv(Q.prototype.getColor(this.anglex)),$t(qe.life),ye.popMatrix()},_t.prototype.advance=function(t){Dt.prototype.rotate.call(this,t)},St.prototype.draw=function(){Qe.viewport(this.box.x,this.box.y,this.box.width,this.box.height);var t=this.box.height/this.box.width;be.load(xe.ortho(-1,1,t,-t,.1,100)),ye.pushMatrix(),ye.translate([0,0,-10]),ye.scale(.3),ye.rotateX(57),ye.rotateZ(106),$t(qe.bike,Se[We.userIndex].model),ye.popMatrix()},Mt.prototype.draw=function(){Qe.viewport(this.box.x,this.box.y,this.box.width,this.box.height);var t=this.box.height/this.box.width;be.load(xe.ortho(-1,1,t,-t,.1,100));
for(var e=0;e<this.colors.length+1;++e)ye.pushMatrix(),ye.translate([0,0,-10]),ye.rotateX(57),ye.rotateZ(106),ye.translate([0,-this.move*this.colors.length*2+2*e,0]),ye.scale(.3),$t(qe.bike,this.colors[e%this.colors.length]),ye.popMatrix()},Mt.prototype.advance=function(t){for(this.move+=1e-4*t;this.move>1;)this.move-=1},ht.prototype.draw3d=function(t){Qe.clear(Qe.COLOR_BUFFER_BIT|Qe.DEPTH_BUFFER_BIT),ye.loadIdentity(),ie(),ei.setTwoSided(!0);for(var e in this.render3d){var i=this.render3d[e];i.advance&&i.advance(t),i.draw()}},ht.prototype.start3dAbove=function(){this.has3dContent=!0,$e.style.zIndex=2,
Qe.clearColor(0,0,0,0),ai=new j},ht.prototype.end3dAbove=function(){hi.render3d=[],hi.has3dContent=!1,$e.style.zIndex=0,Qe.clearColor(0,0,0,1),Qe.clear(Qe.COLOR_BUFFER_BIT|Qe.DEPTH_BUFFER_BIT),ai=null},ht.prototype.drawColorText=function(t,e,i,r){var n=[],o=t.match(/<([0-9]*|\/)>/g);null===o&&(o=[]);for(var a=0,s=0;s<o.length;++s){var l=o[s];a=t.indexOf(l,a),t=t.slice(0,a)+t.slice(a+l.length),n.push({s:a,n:parseInt(l.slice(1,-1))})}for(var u=li.measureText(t).width,h=e-u,a=0,d=li.fillStyle,s=0;s<n.length;s+=2){var c=n[s].s,p=n[s+1].s;if(p!==c){var f=t.slice(a,c);li.fillStyle=d,li.fillText(f,h,i),
a+=f.length,h+=li.measureText(f).width}f=t.slice(c,p),li.fillStyle=r(n[s].n),li.fillText(f,h,i),a+=f.length,h+=li.measureText(f).width}var f=t.slice(a);li.fillStyle=d,li.fillText(f,h,i)},ht.prototype.drawGameState=function(t){if(ui&&(this.blankScr(),li.font="bold "+Oe(.667*this.texth)+"px sans-serif",li.fillStyle="#dda7ff",li.fillText("Lives:",5,this.texth),this.msgQueue.length>0)){li.font="bold 18px sans-serif";for(var e=li.canvas.width,i=(li.canvas.height,0);i<this.msgQueue.length;++i){var r=this.msgQueue[i].text;this.drawColorText(r,e-5,25+22*i,function(t){return oi[t].textColor})}}this.curMenuDraw&&!t&&this.curMenuDraw.call(this);
},ht.MSGID_START_ARROWS=1001,ht.MSGID_PAUSE=1002,ht.prototype.addMessage=function(t,e){this.msgQueue.push({text:t,outTime:(new Date).getTime()+8e3,id:e}),this.drawGameState()},ht.prototype.removeMessage=function(t){var e=!1,i=[];for(var r in this.msgQueue)this.msgQueue[r].id===t?e=!0:i.push(this.msgQueue[r]);e&&(this.msgQueue=i,this.drawGameState())},ht.prototype.checkMessageQueue=function(){if(0!==this.msgQueue.length&&!Ke.isPaused()&&De.handlersSet!==De.HANDLERS_MENU){for(var t=(new Date).getTime(),e=0;this.msgQueue.length&&this.msgQueue[0].outTime<t;)this.msgQueue.shift(),++e;ui&&e>0&&this.drawGameState();
}},ht.prototype.clearMessages=function(){this.msgQueue=[]},Dt.prototype.render=function(){that=this;var t=function(t,e){ye.pushMatrix(),ye.translate([.172+.068*t,.048,-1]),ye.scale(.011*e),ye.rotateX(that.anglex+20*t),ye.rotateZ(that.angley+20*t),$t(qe.life),ye.popMatrix()};be.pushMatrix(),be.load(this.prMatrix),ei.setColorv(this.color);for(var e=0;e<this.count;++e)t(e,1);if(void 0!==this.activeDeath||void 0!==this.activeOneUp){ei.setColorv(ve.x(this.color,this.lightFactor));var i=.2*(this.lightFactor-1)+1;t(e,i)}be.popMatrix()},Dt.ROTX_SPEED=.09,Dt.ROTY_SPEED=.18,Dt.PASS_PEAK_LIGHT=3,Dt.PASS_PEAK_TIME=500,
Dt.PASS_TOTAL_TIME=1e3,Dt.getLightFactor=function(t,e){if(t>=0){if(d=1+2*Math.sin(t/Dt.PASS_TOTAL_TIME*Math.PI),d>0)return d;if(t<=Dt.PASS_PEAK_TIME)return 1+Dt.PASS_PEAK_LIGHT/Dt.PASS_PEAK_TIME*t;if(t<=Dt.PASS_TOTAL_TIME)return Dt.PASS_PEAK_LIGHT-Dt.PASS_PEAK_LIGHT/(Dt.PASS_TOTAL_TIME-Dt.PASS_PEAK_TIME)*(t-Dt.PASS_PEAK_TIME)}return e(),1},Dt.prototype.rotate=function(t){for(this.anglex+=Dt.ROTX_SPEED*t;this.anglex>360;)this.anglex-=360;for(this.angley+=Dt.ROTY_SPEED*t;this.angley>360;)this.angley-=360},Dt.prototype.advance=function(t){if(this.rotate(t),void 0!==this.activeOneUp){var e=this;this.activeOneUp+=t,
this.lightFactor=Dt.getLightFactor(Dt.PASS_TOTAL_TIME-this.activeOneUp,function(){++e.count,e.activeOneUp=void 0,e.pendingDeath&&(e.pendingDeath=!1,e.startDeath())})}else if(void 0!==this.activeDeath){var e=this;this.activeDeath+=t,this.lightFactor=Dt.getLightFactor(this.activeDeath,function(){e.activeDeath=void 0})}},Dt.prototype.startDeath=function(){return void 0!==this.activeOneUp?void(this.pendingDeath=!0):(--this.count,void(this.activeDeath=0))},Dt.prototype.startOneUp=function(){this.activeOneUp=0};var Ue=227;worldModels={cube:{file:"models/cube5quads.json",eyeDist:3.3},triCorner:{file:"models/triCorner4.json",
eyeDist:7},plus:{file:"models/plus4q.json",eyeDist:7},dblsofa:{file:"models/dbl_sofa_soft_4q.json",eyeDist:3.3},softsofa:{file:"models/sofa4q_soft.json",eyeDist:3.54},dDiamond:{file:"models/distortDiamond5q.json",eyeDist:4},torus:{file:"models/torus_100_50s.json",eyeDist:3.66},tetra:{file:"models/tetra1_4q.json",eyeDist:3.4},mobius:{file:"models/mobius_10r_3q.json",eyeDist:1},rotDounut:{file:"models/rot_dounut2.json",eyeDist:4}};var He={Outside:0,Inside:1,FirstPerson:2},Ve=[{worldModel:"cube",numPlayers:2,ai:1,icon:"img/m_cube.png"},{worldModel:"dblsofa",numPlayers:4,ai:1,icon:"img/m_dbl_sofa.png"
},{worldModel:"tetra",numPlayers:3,ai:2,icon:"img/m_tetra.png"},{worldModel:"triCorner",numPlayers:4,ai:2,icon:"img/m_triCorner.png"},{worldModel:"dDiamond",numPlayers:4,ai:3,icon:"img/m_diamond.png"},{worldModel:"cube",numPlayers:3,ai:3,view:He.Inside,icon:"img/m_inside_cube.png"},{worldModel:"plus",numPlayers:4,ai:4,icon:"img/m_plus.png"},{worldModel:"torus",numPlayers:3,ai:4,icon:"img/m_torus.png"},{worldModel:"softsofa",numPlayers:5,ai:5,icon:"img/m_softsofa.png"},{worldModel:"mobius",numPlayers:3,ai:5,icon:"img/m_mobius.png"}],We={userIndex:0,disableDeath:!1,disableEndLevel:!1,debug:!1,printFps:!1,
preloadFirst:1,preloadBatch:3,version:"0.4."+Ue},Ke=new At;At.prototype.setPaused=function(t){t?++this._paused:this._paused>0&&--this._paused,this._startPause&&0===this._paused&&(this._startPause=!1,hi.removeMessage(ht.MSGID_START_ARROWS)),this._startPause||(this._paused>0?hi.addMessage("paused",ht.MSGID_PAUSE):hi.removeMessage(ht.MSGID_PAUSE)),Ze=(new Date).getTime(),Xe("pause: "+this._paused)},At.prototype.setAbsPaused=function(t){this._paused=t?1:0,Ze=(new Date).getTime()},At.prototype.isPaused=function(){return this._paused>0},At.prototype.enableSound=function(t){this.soundEnabled=t};var Ge={
handler:null,called:!1};Ot.prototype.play=function(t){var e=this.players[this.curChannel];this.curChannel=(this.curChannel+1)%this.numChannels,t!==e.volume&&(e.volume=t),e.play()};var Ye=null,qe={_ready:!1},ze={items:{},ondone:null,onprogress:null};if(jt.prototype.draw=function(){ye.pushMatrix(),ye.scale(this.scale),ye.rotate(4*this.time,[1,1,0]),ii.setTime(this.time),$t(this.model),ye.popMatrix()},jt.prototype.advance=function(t){var e=t/1e3;this.time+=e},!Xe)var Xe=function(){};var Qe,je=function(){var t=0,e=0;return function(i){t+=i,++e,e>10&&(fpsui.innerHTML="FPS: "+Math.round(1e3/(t/e)),t=0,
e=0)}}(),Ze=0,Je=0;ue.prototype.getPiece=function(t){var e=this.data[t];return void 0===e?e:65535&e},ue.prototype.getMeta=function(t){var e=this.data[t];return void 0===e?e:e>>16},ue.prototype.get=function(t){return this.data[t]},ue.piece=function(t){return 65535&t},ue.meta=function(t){return t>>16},ue.prototype.set=function(t,e,i){if(e>32767||i>32767)throw Error("Out of range for map "+e+" "+i);this.data[t]=65535&e|i<<16},ue.prototype.unset=function(t){delete this.data[t]};var $e,ei=new u,ii=new u,ri={map:new ue,ready:!1},ni=null,oi=[],ai=null,si=null,li=null,ui=!1,hi=new ht,di=null;return{webGLStart:ge,
hack:fe}}();window.webGLStart=cb.webGLStart;